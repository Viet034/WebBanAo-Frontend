//ver cuoi //login
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đăng nhập & Đăng ký | Colo Shop</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .auth-container {
        max-width: 500px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }
      .form-label {
        font-weight: 500;
      }
      .btn-primary {
        background-color: #fe4c50;
        border-color: #fe4c50;
      }
      .btn-primary:hover {
        background-color: #fe2d31;
        border-color: #fe2d31;
      }
      .toggle-form {
        color: #fe4c50;
        text-decoration: none;
      }
      .toggle-form:hover {
        color: #fe2d31;
      }
      .error-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }
      .success-message {
        color: #198754;
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="auth-container">
        <div class="text-center mb-4">
          <h2 id="formTitle">Đăng nhập</h2>
          <p class="text-muted">Chào mừng bạn đến với Colo Shop</p>
        </div>

        <!-- Form Đăng nhập -->
        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">Loại tài khoản</label>
            <select class="form-select" id="loginUserType" required>
              <option value="Customer">Khách hàng</option>
              <option value="Employee">Nhân viên</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="loginEmail" required />
            <div class="error-message" id="loginEmailError"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Mật khẩu</label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="loginPassword"
                required
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                onclick="togglePassword('loginPassword')"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="error-message" id="loginPasswordError"></div>
          </div>
          <button type="submit" class="btn btn-primary w-100 mb-3">
            Đăng nhập
          </button>
        </form>

        <!-- Form Đăng ký -->
        <form id="registerForm" style="display: none">
          <div class="mb-3">
            <label class="form-label">Loại tài khoản</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="accountType"
                  id="customerType"
                  value="customer"
                  checked
                />
                <label class="form-check-label" for="customerType"
                  >Khách hàng</label
                >
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="accountType"
                  id="employeeType"
                  value="employee"
                />
                <label class="form-check-label" for="employeeType"
                  >Nhân viên</label
                >
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Họ và tên</label>
            <input type="text" class="form-control" id="fullName" required />
            <div class="error-message" id="fullNameError"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="email" required />
            <div class="error-message" id="emailError"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Mật khẩu</label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="password"
                required
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                onclick="togglePassword('password')"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="form-text">
              Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số
              và ký tự đặc biệt
            </div>
            <div class="error-message" id="passwordError"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Số điện thoại</label>
            <input type="tel" class="form-control" id="phone" required />
            <div class="error-message" id="phoneError"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Ngày sinh</label>
            <input type="date" class="form-control" id="dob" required />
            <div class="error-message" id="dobError"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Giới tính</label>
            <select class="form-select" id="gender" required>
              <option value="Male">Nam</option>
              <option value="Female">Nữ</option>
              <option value="Other">Khác</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Địa chỉ</label>
            <input type="text" class="form-control" id="address" required />
            <div class="error-message" id="addressError"></div>
          </div>

          <!-- Trường riêng cho khách hàng -->
          <div class="mb-3 customer-field">
            <label class="form-label">Thành phố</label>
            <input type="text" class="form-control" id="city" />
            <div class="error-message" id="cityError"></div>
          </div>

          <!-- Trường riêng cho nhân viên -->
          <div class="mb-3 employee-field" style="display: none">
            <label class="form-label">Thành phố</label>
            <input type="text" class="form-control" id="employeeCity" />
            <div class="error-message" id="employeeCityError"></div>
          </div>
          <div class="mb-3 employee-field" style="display: none">
            <label class="form-label">Vai trò</label>
            <select class="form-select" id="roleIds">
              <option value="1">Nhân viên</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary w-100 mb-3">
            Đăng ký
          </button>
        </form>

        <div class="text-center">
          <a href="#" class="toggle-form" id="toggleFormBtn"
            >Chưa có tài khoản? Đăng ký ngay</a
          >
        </div>
        <div class="text-center mt-3">
          <a href="index.html" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Quay lại trang chủ
          </a>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Hàm kiểm tra mật khẩu
      function validatePassword(password) {
        const regex =
          /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        return regex.test(password);
      }

      // Hàm hiển thị/ẩn mật khẩu
      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling.querySelector("i");
        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        } else {
          input.type = "password";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        }
      }

      // Xử lý chuyển đổi form
      $(document).ready(function () {
        $("#toggleFormBtn").click(function (e) {
          e.preventDefault();
          const isLogin = $("#loginForm").is(":visible");
          $("#loginForm").toggle(!isLogin);
          $("#registerForm").toggle(isLogin);
          $("#formTitle").text(isLogin ? "Đăng ký" : "Đăng nhập");
          $(this).text(
            isLogin
              ? "Đã có tài khoản? Đăng nhập"
              : "Chưa có tài khoản? Đăng ký ngay"
          );
        });

        // Xử lý hiển thị trường theo loại tài khoản
        $('input[name="accountType"]').change(function () {
          const isCustomer = $(this).val() === "customer";
          $(".customer-field").toggle(isCustomer);
          $(".employee-field").toggle(!isCustomer);
        });

        // Hàm kiểm tra role
        function checkRole(email, userType) {
          return new Promise((resolve, reject) => {
            if (userType === "Customer") {
              resolve(true);
              return;
            }

            const apiEndpoint =
              userType === "Employee"
                ? "Employee/check-role"
                : "Admin/check-role";

            $.ajax({
              url: `https://localhost:7060/api/${apiEndpoint}`,
              type: "POST",
              contentType: "application/json",
              data: JSON.stringify({ email: email }),
              success: function (response) {
                resolve(true);
              },
              error: function (xhr) {
                console.error("Lỗi kiểm tra role:", xhr);
                reject(
                  new Error("Email không tồn tại hoặc không có quyền truy cập")
                );
              },
            });
          });
        }

        // Xử lý đăng nhập
        $("#loginForm").submit(function (e) {
          e.preventDefault();

          // Thêm loading state
          const submitBtn = $(this).find('button[type="submit"]');
          const originalText = submitBtn.text();
          submitBtn
            .prop("disabled", true)
            .html(
              '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...'
            );

          const email = $("#loginEmail").val();
          const password = $("#loginPassword").val();
          const userType = $("#loginUserType").val();

          // Validate dữ liệu
          if (!email || !password) {
            alert("Vui lòng nhập đầy đủ thông tin!");
            submitBtn.prop("disabled", false).text(originalText);
            return;
          }

          // Tạo object data
          const loginData = {
            email: email,
            password: password,
            userType: userType,
          };

          console.log("Dữ liệu đăng nhập:", loginData);

          // Gọi API đăng nhập
          $.ajax({
            url: "https://localhost:7060/api/Auth/login",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(loginData),
            success: function (response) {
              console.log("Đăng nhập thành công:", response);

              // Lưu thông tin vào localStorage
              localStorage.setItem("token", response.token);
              localStorage.setItem("refreshToken", response.refreshToken);
              localStorage.setItem("tokenExpiration", response.tokenExpiration);
              localStorage.setItem("userId", response.userInfo.id);
              localStorage.setItem("userRole", userType);
              localStorage.setItem("userName", response.userInfo.fullName);
              localStorage.setItem("userEmail", response.userInfo.email);

              // Chuyển hướng dựa vào role
              switch (userType) {
                case "Customer":
                  window.location.href = "index.html";
                  break;
                case "Employee":
                  window.location.href = "manager/tongmanager.html";
                  break;
                default:
                  window.location.href = "index.html";
              }
            },
            error: function (xhr) {
              console.error("Chi tiết lỗi đăng nhập:", xhr);
              let errorMessage = "Có lỗi xảy ra khi đăng nhập!";

              if (xhr.responseText) {
                try {
                  if (xhr.responseText.includes("System.Exception:")) {
                    errorMessage = xhr.responseText
                      .split("System.Exception:")[1]
                      .split("\r\n")[0]
                      .trim();
                  } else {
                    const error = JSON.parse(xhr.responseText);
                    errorMessage =
                      error.message || "Email hoặc mật khẩu không đúng";
                  }
                } catch (e) {
                  errorMessage = "Email hoặc mật khẩu không đúng";
                }
              }

              alert(errorMessage);
              submitBtn.prop("disabled", false).text(originalText);
            },
          });
        });

        // Xử lý đăng ký
        $("#registerForm").submit(function (e) {
          e.preventDefault();

          // Validate password
          const password = $("#password").val();
          if (!validatePassword(password)) {
            $("#passwordError").text("Mật khẩu không đạt yêu cầu");
            return;
          }

          const isCustomer = $("#customerType").is(":checked");

          // Dữ liệu cơ bản cho cả Customer và Employee
          const baseData = {
            fullName: $("#fullName").val(),
            email: $("#email").val(),
            password: password,
            phone: $("#phone").val(),
            dob: $("#dob").val(),
            gender: $("#gender").val(),
            address: $("#address").val(),
          };

          let registerData;
          let endpoint;

          if (isCustomer) {
            // Đăng ký Customer
            registerData = {
              ...baseData,
              city: $("#city").val(),
              userType: "Customer",
            };
            endpoint = "https://localhost:7060/api/Auth/register/customer";
          } else {
            // Đăng ký Employee/Admin
            const roleId = $("#roleIds").val();
            registerData = {
              ...baseData,
              city: $("#employeeCity").val(),
              userType: roleId === "1" ? "Employee" : "Admin",
              roleIds: [roleId],
            };
            endpoint = "https://localhost:7060/api/Auth/register/employee";
          }

          console.log("Dữ liệu đăng ký:", registerData);

          // Thêm loading state
          const submitBtn = $(this).find('button[type="submit"]');
          const originalText = submitBtn.text();
          submitBtn
            .prop("disabled", true)
            .html(
              '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...'
            );

          $.ajax({
            url: endpoint,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(registerData),
            success: function (response) {
              console.log("Đăng ký thành công:", response);
              alert("Đăng ký thành công! Vui lòng đăng nhập.");
              $("#toggleFormBtn").click(); // Chuyển về form đăng nhập
            },
            error: function (xhr) {
              console.error("Lỗi đăng ký:", xhr);
              let errorMessage = "Đăng ký thất bại! ";

              if (xhr.responseText) {
                try {
                  if (xhr.responseText.includes("System.Exception:")) {
                    errorMessage += xhr.responseText
                      .split("System.Exception:")[1]
                      .split("\r\n")[0]
                      .trim();
                  } else {
                    const errorResponse = JSON.parse(xhr.responseText);
                    if (errorResponse && errorResponse.errors) {
                      const errors = Object.values(errorResponse.errors).flat();
                      errorMessage += errors.join("\n");
                    } else {
                      errorMessage +=
                        errorResponse.message ||
                        "Vui lòng kiểm tra lại thông tin.";
                    }
                  }
                } catch (e) {
                  errorMessage += "Vui lòng kiểm tra lại thông tin.";
                }
              }

              alert(errorMessage);
            },
            complete: function () {
              submitBtn.prop("disabled", false).text(originalText);
            },
          });
        });
      });
    </script>
  </body>
</html>

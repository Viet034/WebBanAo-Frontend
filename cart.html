
<!DOCTYPE html>
<html lang="en">
<head>
<title>Giỏ hàng</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Colo Shop Template">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="styles/bootstrap4/bootstrap.min.css">
<link href="plugins/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="plugins/OwlCarousel2-2.2.1/owl.carousel.css">
<link rel="stylesheet" type="text/css" href="plugins/OwlCarousel2-2.2.1/owl.theme.default.css">
<link rel="stylesheet" type="text/css" href="plugins/OwlCarousel2-2.2.1/animate.css">
<link rel="stylesheet" href="plugins/themify-icons/themify-icons.css">
<link rel="stylesheet" type="text/css" href="plugins/jquery-ui-1.12.1.custom/jquery-ui.css">
<link rel="stylesheet" type="text/css" href="styles/cart_styles.css">
<link rel="stylesheet" type="text/css" href="styles/contact_responsive.css">
<link rel="stylesheet" type="text/css" href="styles/main_styles.css">
<link rel="stylesheet" type="text/css" href="styles/responsive.css">
<style>
    .voucher-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .voucher-item {
        transition: all 0.2s ease;
    }
    
    .voucher-item:hover {
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .cart_item {
        margin-bottom: 15px;
        padding: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .cart_item_image {
        width: 100px;
        margin-right: 15px;
    }
    
    .cart_item_image img {
        max-width: 100%;
    }
    
    .cart_item_name_container {
        flex-grow: 1;
    }
    
    .cart_item_quantity, .cart_item_price, .cart_item_total {
        margin: 0 15px;
    }
    
    .quantity_selector {
        display: flex;
        align-items: center;
    }
</style>
<style>
      
    .product_image {
      width: 100%;
      height: 250px;  /* Chiều cao cố định cho tất cả ảnh */
      overflow: hidden;
      position: relative;
    }

    .product_image img {
      width: 100%;
      height: 100%;
      object-fit: cover;  /* Giữ tỷ lệ ảnh và cắt phần thừa */
      object-position: center;  /* Căn giữa ảnh */
    }

    
    .search-popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }

    .search-popup-content {
      position: relative;
      width: 95%;
      max-width: 1200px;
      margin: 30px auto;
      background-color: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    #searchInput {
      width: 100%;
      padding: 15px; /* Tăng padding */
      font-size: 16px;
      border: 2px solid #ddd; /* Tăng độ dày viền */
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .search-results {
      max-height: 75vh; /* Tăng chiều cao tối đa */
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: white;
    }

    .search-item {
      padding: 12px 20px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .search-item:hover {
      background-color: #f8f8f8;
    }

    .search-item-content {
      display: flex;
      gap: 15px;
      min-height: 50px; /* Đảm bảo chiều cao tối thiểu bằng với ảnh */
    }

    .search-item-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .search-item-details {
      flex: 1;
      display: flex;
      align-items: center;
    }

    .search-item-name {
      font-size: 15px;
      font-weight: 500;
      margin: 0;
      line-height: 1.4; /* Tăng line-height để dễ đọc khi xuống dòng */
      white-space: normal; /* Cho phép xuống dòng */
      overflow: visible; /* Cho phép hiển thị toàn bộ text */
      width: 100%;
      padding-right: 20px; /* Thêm padding bên phải để tránh text sát mép */
    }

    .search-item-price {
      font-size: 18px;
      color: #fe4c50;
      font-weight: bold;
    }

    .search-container {
      position: relative;
    }

    #searchInput {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      width: 350px;
      max-height: 75vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: white;
      z-index: 1000;
      display: none;
    }

    .search-item {
      padding: 12px 20px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .search-item:hover {
      background-color: #f8f8f8;
    }

    .search-item-content {
      display: flex;
      gap: 15px;
      min-height: 50px;
    }

    .search-item-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .search-item-details {
      flex: 1;
      display: flex;
      align-items: center;
    }

    .search-item-name {
      font-size: 15px;
      font-weight: 500;
      margin: 0;
      line-height: 1.4;
      white-space: normal;
      overflow: visible;
      width: 100%;
      padding-right: 20px;
    }
  </style>
</head>

<body>

<div class="super_container">

	<!-- Header -->

	<header class="header trans_300">
        <!-- Top Navigation -->

        <div class="top_nav">
          <div class="container">
            <div class="row">
              <div class="col-md-6">
                <div class="top_nav_left">Bán có tâm, Ắt có tầm</div>
              </div>
              <div class="col-md-6 text-right">
                <div class="top_nav_right">
                  <ul class="top_nav_menu">
                    

                    
                    <li class="language">
                      <a href="#">
                        Tiếng Việt
                        <i class="fa fa-angle-down"></i>
                      </a>
                      <ul class="language_selection">
                        <li><a href="#">Tiếng Việt</a></li>
                      </ul>
                    </li>
                    <li class="account">
                      <a href="#">
                        Tài khoản
                        <i class="fa fa-angle-down"></i>
                      </a>
                      <ul class="account_selection">
                        <li id="loginSection">
                          <a href="login.html">
                            <i class="fa fa-sign-in" aria-hidden="true"></i>Đăng nhập
                            
                          </a>
                        </li>
                        <li id="registerSection">
                          <a href="#">
                            <i class="fa fa-user-plus" aria-hidden="true"></i
                            >Đăng ký
                          </a>
                        </li>
                        <li id="userSection" style="display: none">
                          <a href="profile.html">
                            <i class="fa fa-user" aria-hidden="true"></i>
                            <span id="userFullName"></span>
                          </a>
                        </li>
                        <li id="logoutSection" style="display: none">
                          <a href="#" id="logoutBtn">
                            <i class="fa fa-sign-out" aria-hidden="true"> Đăng xuất</i
                            >
                          </a>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Navigation -->

        <div class="main_nav_container">
          <div class="container">
            <div class="row">
              <div class="col-lg-12 text-right">
                <div class="logo_container">
                  <a href="index.html">Tien<span>Tien </span></a>
                </div>
                <nav class="navbar">
                  <ul class="navbar_menu">
                    <li><a href="index.html">Trang chủ</a></li>
                    <li><a href="categories.html">danh mục </a></li>

                    <li><a href="contact.html">Liên hệ </a></li>
                  </ul>
                  <ul class="navbar_user">
                    <li>
                      <div class="search-container">
                        <input type="text" id="searchInput" placeholder="Tìm kiếm sản phẩm..." />
                        <div id="searchResults" class="search-results"></div>
                      </div>
                    </li>
                    <li>
                      <a href="profile.html"
                        ><i class="fa fa-user" aria-hidden="true"></i
                      ></a>
                    </li>
                    <li class="checkout">
                      <a href="cart.html">
                        <i class="fa fa-shopping-cart" aria-hidden="true"></i>
                        <span id="checkout_items" class="checkout_items"
                          >0</span
                        >
                      </a>
                    </li>
                  </ul>
                  <div class="hamburger_container">
                    <i class="fa fa-bars" aria-hidden="true"></i>
                  </div>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </header>

	<div class="fs_menu_overlay"></div>

	<!-- Hamburger Menu -->

	

	<div class="container contact_container">
		<div class="row">
			<div class="col">

				<!-- Breadcrumbs -->

				<div class="breadcrumbs d-flex flex-row align-items-center">
					<ul>
						<li><a href="index.html">Home</a></li>
						<li class="active"><a href="#"><i class="fa fa-angle-right" aria-hidden="true"></i>Contact</a></li>
					</ul>
				</div>

			</div>
		</div>

		<!-- Cart Content -->
        <div class="cart_section">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="cart_container">
                            <h2>Giỏ hàng của bạn</h2>
                            
                            <!-- Cart Items -->
                            <div class="cart_items">
                                <!-- Items will be loaded here -->
                            </div>

                            <!-- Cart Total -->
                            <div class="cart_totals mt-4">
                                <div class="row">
                                    <div class="col-md-6 offset-md-6">
                                        <div class="cart_total_container">
                                            <h4>Tổng giỏ hàng</h4>
                                            <div class="cart_total_amount">
                                                <span>Tổng tiền:</span>
                                                <span id="cartTotal">0đ</span>
                                            </div>
                                            <div class="voucher_section mt-2 mb-3">
                                                <button class="btn btn-outline-secondary btn-sm" onclick="openVoucherModal()">
                                                    <i class="fa fa-ticket"></i> Chọn voucher
                                                </button>
                                                <div id="selectedVoucher" class="mt-2" style="display: none;">
                                                    <div class="alert alert-success p-2">
                                                        <small>Voucher: <span id="voucherName"></span></small>
                                                        <button type="button" class="close" onclick="removeVoucher()">
                                                            <span>&times;</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary checkout_button" onclick="proceedToCheckout()">
                                                Thanh toán
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

	<!-- Footer -->

	<footer class="footer">
		<div class="container">
			<div class="row">
				<div class="col-lg-6">
					<div class="footer_nav_container d-flex flex-sm-row flex-column align-items-center justify-content-lg-start justify-content-center text-center">
						<ul class="footer_nav">
							<li><a href="#">Blog</a></li>
							<li><a href="#">FAQs</a></li>
							<li><a href="contact.html">Contact us</a></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="footer_social d-flex flex-row align-items-center justify-content-lg-end justify-content-center">
						<ul>
							<li><a href="#"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
							<li><a href="#"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
							<li><a href="#"><i class="fa fa-instagram" aria-hidden="true"></i></a></li>
							<li><a href="#"><i class="fa fa-skype" aria-hidden="true"></i></a></li>
							<li><a href="#"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li>
						</ul>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<div class="footer_nav_container">
						<div class="cr">©2018 All Rights Reserverd. Template by <a href="#">Colorlib</a> &amp; distributed by <a href="https://themewagon.com">ThemeWagon</a></div>
					</div>
				</div>
			</div>
		</div>
	</footer>

</div>

<script src="js/jquery-3.2.1.min.js"></script>
<script src="styles/bootstrap4/popper.js"></script>
<script src="styles/bootstrap4/bootstrap.min.js"></script>
<script src="plugins/Isotope/isotope.pkgd.min.js"></script>
<script src="plugins/OwlCarousel2-2.2.1/owl.carousel.js"></script>
<script src="plugins/easing/easing.js"></script>
<script src="plugins/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
<script src="js/contact_custom.js"></script>

<!-- Voucher Modal -->
<div class="modal fade" id="voucherModal" tabindex="-1" role="dialog" aria-labelledby="voucherModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="voucherModalLabel">Chọn Voucher</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="voucherList" class="voucher-list">
                    <!-- Vouchers will be loaded here -->
                    <div class="text-center py-3" id="voucherLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    <div id="noVouchers" style="display: none;" class="text-center py-3">
                        <p>Bạn không có voucher nào khả dụng</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="loadCustomerVouchers()">
                    <i class="fa fa-refresh"></i> Tải lại
                </button>
                <button type="button" class="btn btn-warning" onclick="showAllVouchers()">
                    <i class="fa fa-list"></i> Hiển thị tất cả
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script>
	$(document).ready(function () {
	  // Kiểm tra trạng thái đăng nhập
	  function checkLoginStatus() {
		const token = localStorage.getItem("token");
		const userRole = localStorage.getItem("userRole");
		const userName = localStorage.getItem("userName");

		if (token && userRole === "Customer") {
		  // Đã đăng nhập
		  $("#loginSection, #registerSection").hide();
		  $("#userSection, #logoutSection").show();
		  $("#userFullName").text(userName);
		} else {
		  // Chưa đăng nhập
		  $("#loginSection, #registerSection").show();
		  $("#userSection, #logoutSection").hide();
		}
	  }

	  // Xử lý đăng xuất
	  $("#logoutBtn").click(function (e) {
		e.preventDefault();

		// Xóa thông tin đăng nhập khỏi localStorage
		localStorage.removeItem("token");
		localStorage.removeItem("refreshToken");
		localStorage.removeItem("tokenExpiration");
		localStorage.removeItem("userId");
		localStorage.removeItem("userRole");
		localStorage.removeItem("userName");
		localStorage.removeItem("userEmail");

		// Chuyển hướng về trang đăng nhập
		window.location.href = "login.html";
	  });

	  // Kiểm tra trạng thái đăng nhập khi trang được tải
	  checkLoginStatus();
	});
  </script>
<script>
// Hàm format tiền tệ
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
}

// Biến lưu voucher đã chọn
let selectedVoucherId = null;
let selectedVoucherName = '';

// Thêm biến để lưu tổng tiền gốc
let originalTotal = 0;

// Hàm mở modal chọn voucher
function openVoucherModal() {
    loadCustomerVouchers();
    $('#voucherModal').modal('show');
}

// Hàm tải danh sách voucher của khách hàng
function loadCustomerVouchers() {
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    
    if (!token || !userId) {
        alert('Vui lòng đăng nhập để xem voucher!');
        return;
    }
    
    $('#voucherLoading').show();
    $('#noVouchers').hide();
    
    console.log('Đang tải voucher cho user ID:', userId);
    
    $.ajax({
        url: `https://localhost:7060/api/CustomerVoucher/customer/${userId}`,
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        success: function(response) {
            $('#voucherLoading').hide();
            console.log('API Response:', response);
            
            if (!response || response.length === 0) {
                $('#noVouchers').show();
                return;
            }
            
            let voucherHtml = '';
            let validVoucherCount = 0;
            
            response.forEach(voucher => {
                // Kiểm tra trạng thái voucher thay vì dựa vào ngày hết hạn
                const isValid = voucher.status === 'Active';
                
                console.log('Voucher:', voucher.voucherName, 
                            'Status:', voucher.status,
                            'IsValid:', isValid);
                
                if (isValid) {
                    validVoucherCount++;
                    voucherHtml += `
                        <div class="voucher-item card mb-2 ${selectedVoucherId === voucher.voucherId ? 'border-primary' : ''}">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${voucher.voucherName}</h6>
                                        <p class="mb-0 small">Giảm: ${voucher.discountAmount || ''}${voucher.discountType === 'Percentage' ? '%' : 'đ'}</p>
                                        <small class="text-muted">Trạng thái: ${voucher.status}</small>
                                    </div>
                                    <button class="btn btn-sm ${selectedVoucherId === voucher.voucherId ? 'btn-primary' : 'btn-outline-primary'}" 
                                            onclick="selectVoucher(${voucher.voucherId}, '${voucher.voucherName}')">
                                        ${selectedVoucherId === voucher.voucherId ? 'Đã chọn' : 'Chọn'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            console.log('Số voucher hợp lệ:', validVoucherCount);
            
            if (validVoucherCount === 0) {
                $('#noVouchers').show();
            } else {
                $('#voucherList').html(voucherHtml);
            }
        },
        error: function(xhr) {
            $('#voucherLoading').hide();
            $('#noVouchers').show();
            console.error('Lỗi khi tải voucher:', xhr);
            console.error('Status:', xhr.status);
            console.error('Response:', xhr.responseText);
            
            if (xhr.status === 401) {
                alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                window.location.href = 'login.html';
            } else {
                alert('Không thể tải voucher. Vui lòng thử lại sau. Lỗi: ' + (xhr.responseText || xhr.statusText));
            }
            
            // Thử phương án thay thế
            tryAlternativeVoucherAPI();
        }
    });
}

// Thử trực tiếp với API khác nếu API chính không hoạt động
function tryAlternativeVoucherAPI() {
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    
    if (!token || !userId) return;
    
    // Thử với endpoint khác (nếu có)
    $.ajax({
        url: `https://localhost:7060/api/Voucher/available`,
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        success: function(response) {
            console.log('Alternative API Response:', response);
            
            if (!response || response.length === 0) return;
            
            let voucherHtml = '';
            response.forEach(voucher => {
                const isValid = voucher.status === 'Active' && new Date(voucher.endDate) > new Date();
    
            console.log('Voucher:', voucher.voucherName, 
                        'Status:', voucher.status,
                        'IsValid:', isValid);
                        if(isValid){
                            validVoucherCount++;
                            voucherHtml += `
                    <div class="voucher-item card mb-2">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${voucher.name || voucher.voucherName}</h6>
                                    <p class="mb-0 small">Giảm: ${voucher.discountAmount || voucher.amount}${voucher.discountType === 'Percentage' || voucher.type === 'Percentage' ? '%' : 'đ'}</p>
                                    <small class="text-muted">Hết hạn: ${new Date(voucher.expiryDate || voucher.expiry).toLocaleDateString()}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="selectVoucher(${voucher.id || voucher.voucherId}, '${voucher.name || voucher.voucherName}')">
                                    Chọn
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                        }
                
            });
            
            $('#voucherList').html(voucherHtml);
            $('#noVouchers').hide();
        },
        error: function(xhr) {
            console.error('Alternative API error:', xhr);
        }
    });
}

// Hàm chọn voucher
function selectVoucher(voucherId, voucherName) {
    if (!voucherId) {
        console.error('Voucher ID không hợp lệ:', voucherId);
        alert('Không thể chọn voucher này. Vui lòng thử lại.');
        return;
    }
    
    console.log('Đã chọn voucher:', voucherId, voucherName);
    
    selectedVoucherId = voucherId;
    selectedVoucherName = voucherName || 'Voucher #' + voucherId;
    
    // Hiển thị voucher đã chọn
    $('#selectedVoucher').show();
    
    // Tính lại tổng tiền với voucher
    updateTotalWithVoucher();
    
    // Đóng modal
    $('#voucherModal').modal('hide');
}

// Hàm xóa voucher đã chọn
function removeVoucher() {
    selectedVoucherId = null;
    selectedVoucherName = '';
    $('#selectedVoucher').hide();
    // Hiển thị lại tổng tiền gốc
    $('#cartTotal').text(formatCurrency(originalTotal));
}

// Hàm load giỏ hàng
function loadCart() {
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    
    if (!token || !userId) {
        alert('Vui lòng đăng nhập để xem giỏ hàng!');
        window.location.href = 'login.html';
        return;
    }

    $.ajax({
        url: `https://localhost:7060/api/Cart/get-cart/${userId}`,
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        success: function(response) {
            const cartItems = response.items;
            let cartHtml = '';

            if (!cartItems || cartItems.length === 0) {
                cartHtml = '<div class="text-center p-4"><h4>Giỏ hàng trống</h4></div>';
                $('.cart_items').html(cartHtml);
                $('#cartTotal').text(formatCurrency(0));
                $('#checkout_items').text('0');
                originalTotal = 0;
                return;
            }

            cartItems.forEach(item => {
                cartHtml += `
                    <div class="cart_item d-flex flex-lg-row flex-column align-items-lg-center align-items-start justify-content-start">
                        <div class="cart_item_image">
                            <img src="${item.productImage}" alt="${item.productName}">
                        </div>
                        <div class="cart_item_name_container">
                            <div class="cart_item_name"><a href="#">${item.productName}</a></div>
                            <div class="cart_item_edit">
                                <span class="me-3">Size: ${item.size}</span>
                                <span class="me-3">Màu: ${item.color}</span>
                                <button class="btn btn-sm btn-danger" onclick="removeFromCart(${item.cartDetailId})">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="cart_item_quantity">
    <div class="quantity_selector">
        <button class="btn btn-sm btn-secondary" 
                onclick="updateQuantity(${item.cartDetailId}, ${item.quantity - 1})">-</button>
        <span class="mx-2">${item.quantity}</span>
        <button class="btn btn-sm btn-secondary" 
                onclick="updateQuantity(${item.cartDetailId}, ${item.quantity + 1})">+</button>
    </div>
</div>
                        <div class="cart_item_price">${formatCurrency(item.price)}</div>
                        <div class="cart_item_total">${formatCurrency(item.subtotal)}</div>
                    </div>
                `;
            });

            $('.cart_items').html(cartHtml);
            originalTotal = response.totalAmount; // Lưu tổng tiền gốc
            updateTotalWithVoucher(); // Cập nhật tổng tiền với voucher (nếu có)
            $('#checkout_items').text(cartItems.length);
        },
        error: function(xhr) {
            console.error('Lỗi khi tải giỏ hàng:', xhr);
            if (xhr.status === 401) {
                alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                window.location.href = 'login.html';
            } else {
                alert('Không thể tải giỏ hàng. Vui lòng thử lại sau.');
            }
        }
    });
}

function proceedToCheckout(){
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    
    let orderData = {
        customerId: userId,
        voucherId: selectedVoucherId,  // Sử dụng voucher đã chọn
        note: "Giao hàng nhanh"  
    };
    
    console.log('Dữ liệu đặt hàng:', orderData);
    
    $.ajax({
        url: `https://localhost:7060/api/Order/checkout`,
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(orderData),
        success: function(response){
            console.log('Đã thanh toán thành công:', response);
            alert('Đặt hàng thành công!');
            loadCart();
            // Reset voucher đã chọn
            removeVoucher();
        },
        error: function(xhr){
            console.error('Lỗi khi thanh toán:', xhr);
            console.error('Status:', xhr.status);
            console.error('Response:', xhr.responseText);
            
            if (xhr.status === 401) {
                alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                window.location.href = 'login.html';
            } else {
                alert('Không thể thanh toán. Lỗi: ' + (xhr.responseText || 'Vui lòng thử lại sau.'));
            }
        }
    });
}

// Hàm cập nhật số lượng
function updateQuantity(cartDetailId, newQuantity) {
    if (newQuantity < 1) return;

    const token = localStorage.getItem('token');
    
    const updateData = {
        cartDetailId: cartDetailId,
        quantity: newQuantity
    };

    $.ajax({
        url: 'https://localhost:7060/api/Cart/update-quantity',
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(updateData),
        success: function(response) {
            console.log('Cập nhật số lượng thành công:', response);
            loadCart(); // Tải lại giỏ hàng sau khi cập nhật thành công
        },
        error: function(xhr) {
            console.error('Lỗi khi cập nhật số lượng:', xhr);
            if (xhr.status === 401) {
                alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                window.location.href = 'login.html';
            } else {
                alert('Không thể cập nhật số lượng. Vui lòng thử lại sau.');
            }
        }
    });
}

// Hàm xóa sản phẩm khỏi giỏ hàng
function removeFromCart(cartDetailId) {
    if (!confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) return;

    const token = localStorage.getItem('token');
    $.ajax({
        url: `https://localhost:7060/api/Cart/remove-item/${cartDetailId}`,
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        success: function() {
            loadCart(); // Tải lại giỏ hàng
        },
        error: function(xhr) {
            console.error('Lỗi khi xóa sản phẩm:', xhr);
            alert('Không thể xóa sản phẩm. Vui lòng thử lại sau.');
        }
    });
}

// Load giỏ hàng khi trang được tải
$(document).ready(function() {
    loadCart();
});

// Thêm nút để hiển thị tất cả voucher
function showAllVouchers() {
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');
    
    if (!token || !userId) return;
    
    $('#voucherLoading').show();
    $('#noVouchers').hide();
    
    $.ajax({
        url: `https://localhost:7060/api/CustomerVoucher/customer/${userId}`,
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        success: function(response) {
            $('#voucherLoading').hide();
            
            if (!response || response.length === 0) {
                $('#noVouchers').show();
                return;
            }
            
            let voucherHtml = '';
            
            response.forEach(voucher => {
                // Hiển thị tất cả voucher
                const isDisabled = voucher.status !== 'Active';
                
                voucherHtml += `
                    <div class="voucher-item card mb-2 ${selectedVoucherId === voucher.voucherId ? 'border-primary' : ''} ${isDisabled ? 'bg-light' : ''}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${voucher.voucherName}</h6>
                                    <p class="mb-0 small">ID: ${voucher.voucherId}</p>
                                    <small class="text-muted">Trạng thái: ${voucher.status}</small>
                                </div>
                                <button class="btn btn-sm ${selectedVoucherId === voucher.voucherId ? 'btn-primary' : 'btn-outline-primary'}" 
                                        onclick="selectVoucher(${voucher.voucherId}, '${voucher.voucherName}')"
                                        ${isDisabled ? 'disabled' : ''}>
                                    ${isDisabled ? 'Hết hạn' : (selectedVoucherId === voucher.voucherId ? 'Đã chọn' : 'Chọn')}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            $('#voucherList').html(voucherHtml);
        },
        error: function(xhr) {
            $('#voucherLoading').hide();
            $('#noVouchers').show();
            console.error('Lỗi khi tải tất cả voucher:', xhr);
        }
    });
}

// Cập nhật hàm tính lại tổng tiền sau khi áp dụng voucher
function updateTotalWithVoucher() {
    if (!selectedVoucherId) {
        // Nếu không có voucher, hiển thị tổng tiền gốc
        $('#cartTotal').text(formatCurrency(originalTotal));
        return;
    }

    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');

    // Sử dụng API calculate-with-voucher
    $.ajax({
        url: `https://localhost:7060/api/Order/calculate-with-voucher?customerId=${userId}&voucherId=${selectedVoucherId}`,
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        success: function(response) {
            console.log('Kết quả tính toán với voucher:', response);
            
            // Cập nhật hiển thị tổng tiền sau khi áp dụng voucher
            $('#cartTotal').text(formatCurrency(response.finalAmount));
            
            // Hiển thị thông tin giảm giá
            const discountAmount = originalTotal - response.finalAmount;
            $('#voucherName').html(`${selectedVoucherName}<br><small>Giảm ${formatCurrency(discountAmount)}</small>`);
        },
        error: function(xhr) {
            console.error('Lỗi khi tính toán với voucher:', xhr);
            console.error('Status:', xhr.status);
            console.error('Response:', xhr.responseText);
            
            // Nếu có lỗi, hiển thị tổng tiền gốc
            $('#cartTotal').text(formatCurrency(originalTotal));
            
            // Thông báo lỗi cho người dùng
            if (xhr.status === 400) {
                // Có thể voucher không hợp lệ hoặc không đủ điều kiện
                alert('Không thể áp dụng voucher này. ' + (xhr.responseJSON?.message || 'Vui lòng chọn voucher khác.'));
                removeVoucher(); // Xóa voucher đã chọn
            } else if (xhr.status === 401) {
                alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                window.location.href = 'login.html';
            } else {
                alert('Có lỗi xảy ra khi tính toán giá trị voucher. Vui lòng thử lại sau.');
            }
        }
    });
}
</script>
<script>
    $(document).ready(function() {
      
      function updateCartCount() {
              const token = localStorage.getItem('token');
              const customerId = localStorage.getItem('userId');
              
              if (!token || !customerId) return;
      
              $.ajax({
                  url: `https://localhost:7060/api/Cart/get-cart/${customerId}`,
                  method: 'GET',
                  headers: {
                      'Authorization': `Bearer ${token}`
                  },
                  success: function(response) {
                      const totalItems = response.items.reduce((sum, item) => sum + item.quantity, 0);
                      $('#checkout_items').text(totalItems);
                  }
              });
          }
          $(document).on('click', '.add_to_cart_link ', function(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('token');
            const customerId = localStorage.getItem('userId');
            
            if (!token || !customerId) {
                alert('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng!');
                window.location.href = 'login.html';
                return;
            }
    
            const productDetailId = $(this).data('product-id');
            console.log('ProductDetailId:', productDetailId); // Log để debug
    
            // Kiểm tra sản phẩm đã có trong giỏ hàng chưa
            $.ajax({
                url: `https://localhost:7060/api/Cart/get-cart/${customerId}`,
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                success: function(cartResponse) {
                    const existingItem = cartResponse.items.find(item => 
                        item.productDetailId === productDetailId
                    );
    
                    if (existingItem) {
                        // Nếu sản phẩm đã tồn tại, cập nhật số lượng
                        const updateData = {
                            cartDetailId: existingItem.cartDetailId,
                            quantity: existingItem.quantity + 1
                        };
    
                        $.ajax({
                            url: 'https://localhost:7060/api/Cart/update-quantity',
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            data: JSON.stringify(updateData),
                            success: function(response) {
                                alert('Đã cập nhật số lượng trong giỏ hàng!');
                                updateCartCount();
                            },
                            error: function(xhr) {
                                console.error('Lỗi khi cập nhật số lượng:', xhr);
                                alert('Không thể cập nhật số lượng. Vui lòng thử lại sau.');
                            }
                        });
                    } else {
                        // Nếu sản phẩm chưa có trong giỏ hàng, thêm mới
                        const cartData = {
                            productDetailId: parseInt(productDetailId), // Đảm bảo là số
                            quantity: 1,
                            customerId: parseInt(customerId)
                        };
    
                        console.log('Dữ liệu gửi đi:', cartData); // Log để debug
    
                        $.ajax({
                            url: 'https://localhost:7060/api/Cart/add-to-cart',
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            data: JSON.stringify(cartData),
                            success: function(response) {
                                alert('Thêm vào giỏ hàng thành công!');
                                updateCartCount();
                            },
                            error: function(xhr) {
                                console.error('Lỗi khi thêm vào giỏ hàng:', xhr);
                                let errorMessage = 'Không thể thêm vào giỏ hàng. ';
                                
                                if (xhr.responseText) {
                                    try {
                                        const errorResponse = JSON.parse(xhr.responseText);
                                        errorMessage += errorResponse.message || 'Vui lòng thử lại sau.';
                                    } catch (e) {
                                        errorMessage += 'Vui lòng thử lại sau.';
                                    }
                                }
                                
                                alert(errorMessage);
                            }
                        });
                    }
                },
                error: function(xhr) {
                    console.error('Lỗi khi kiểm tra giỏ hàng:', xhr);
                    if (xhr.status === 401) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = 'login.html';
                    } else {
                        alert('Không thể kiểm tra giỏ hàng. Vui lòng thử lại sau.');
                    }
                }
            });
            updateCartCount();
          });
        });
        </script>
        <script>
            $(document).ready(function () {
              // Show popup when clicking search icon
              $("#searchIcon").click(function(e) {
                e.preventDefault();
                $("#searchPopup").fadeIn(200);
                $("#searchInput").focus();
              });
      
              // Close popup when clicking outside
              $("#searchPopup").click(function(e) {
                if ($(e.target).is("#searchPopup")) {
                  $(this).fadeOut(200);
                }
              });
      
              // Search functionality
              let searchTimeout; // Thêm biến để debounce
              
              $("#searchInput").on("input", function () {
                const query = $(this).val();
                const token = localStorage.getItem("token");
      
                // Clear previous timeout
                clearTimeout(searchTimeout);
      
                if (query.length > 0) {
                  // Set new timeout
                  searchTimeout = setTimeout(() => {
                    $.ajax({
                      url: `https://localhost:7060/api/ProductDetail/FindByName/${query}`,
                      method: 'GET',
                      headers: {
                        'Authorization': `Bearer ${token}`
                      },
                      success: function(products) {
                        $("#searchResults").empty(); // Xóa kết quả cũ
                        
                        if (products && products.length > 0) {
                          const processedProducts = new Set(); // Theo dõi sản phẩm đã xử lý
      
                          products.forEach(product => {
                            // Kiểm tra nếu sản phẩm đã được xử lý
                            if (!processedProducts.has(product.id)) {
                              processedProducts.add(product.id); // Đánh dấu là đã xử lý
      
                              $.ajax({
                                url: `https://localhost:7060/api/ProductImage/productDetailId/${product.id}`,
                                method: 'GET',
                                headers: {
                                  'Authorization': `Bearer ${token}`
                                },
                                success: function(images) {
                                  const imageUrl = images && images.length > 0 
                                    ? images[0].url 
                                    : 'images/product_placeholder.jpg';
                                  
                                  const productHtml = `
                                    <div class="search-item" data-id="${product.id}">
                                      <div class="search-item-content">
                                        <img src="${imageUrl}" alt="${product.name}" class="search-item-image">
                                        <div class="search-item-details">
                                          <div class="search-item-name">${product.name}</div>
                                        </div>
                                      </div>
                                    </div>
                                  `;
                                  
                                  $("#searchResults").append(productHtml);
                                },
                                error: function() {
                                  // Nếu không lấy được ảnh, vẫn hiển thị sản phẩm với ảnh mặc định
                                  const productHtml = `
                                    <div class="search-item" data-id="${product.id}">
                                      <div class="search-item-content">
                                        <img src="images/product_placeholder.jpg" alt="${product.name}" class="search-item-image">
                                        <div class="search-item-details">
                                          <div class="search-item-name">${product.name}</div>
                                        </div>
                                      </div>
                                    </div>
                                  `;
                                  
                                  $("#searchResults").append(productHtml);
                                }
                              });
                            }
                          });
                          
                          $("#searchResults").show();
                        } else {
                          $("#searchResults").html('<div class="search-item">Không tìm thấy sản phẩm</div>');
                          $("#searchResults").show();
                        }
                      },
                      error: function(xhr) {
                        console.error("Lỗi khi tìm kiếm:", xhr);
                        $("#searchResults").html('<div class="search-item">Đã xảy ra lỗi khi tìm kiếm</div>');
                        $("#searchResults").show();
                      }
                    });
                  }, 300); // Đợi 300ms sau khi người dùng ngừng gõ
                } else {
                  $("#searchResults").hide();
                }
              });
      
              // Handle product click
              $(document).on("click", ".search-item", function () {
                const productId = $(this).data("id");
                window.location.href = `single.html?id=${productId}`;
              });
      
              // Clear search when popup closes
              $("#searchPopup").on("hidden", function() {
                $("#searchInput").val("");
                $("#searchResults").hide();
              });
            });
          </script>
</body>

</html>

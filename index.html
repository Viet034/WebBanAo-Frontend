

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>TienTien Shop</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Colo Shop Template" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      type="text/css"
      href="styles/bootstrap4/bootstrap.min.css"
    />
    <link
      href="plugins/font-awesome-4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="plugins/OwlCarousel2-2.2.1/owl.carousel.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="plugins/OwlCarousel2-2.2.1/owl.theme.default.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="plugins/OwlCarousel2-2.2.1/animate.css"
    />
    <link rel="stylesheet" type="text/css" href="styles/main_styles.css" />
    <link rel="stylesheet" type="text/css" href="styles/responsive.css" />
    <style>
      .banner_item {
        margin-left: 30px;  /* Thêm margin bên trái */
      }

      /* Hoặc nếu muốn dịch cả container */
      #banner-container {
        padding-left: 30px;  /* Thêm padding bên trái */
      }

      /* Style cho product items trong slider */
      .product_image {
        width: 100%;
        height: 250px;  /* Chiều cao cố định cho tất cả ảnh */
        overflow: hidden;
        position: relative;
      }

      .product_image img {
        width: 100%;
        height: 100%;
        object-fit: cover;  /* Giữ tỷ lệ ảnh và cắt phần thừa */
        object-position: center;  /* Căn giữa ảnh */
      }

      /* Đảm bảo các item có kích thước đồng đều */
      .product-item {
        padding: 0 10px;  /* Thêm khoảng cách giữa các items */
      }

      .product {
        margin-bottom: 5px;  /* Giảm margin bottom */
      }

      /* Đảm bảo phần thông tin sản phẩm có đủ khoảng trống */
      .product_info {
        min-height: 45px;  /* Giảm chiều cao tối thiểu */
        margin-bottom: 0;  /* Bỏ margin bottom */
      }

      /* Style cho nút thêm giỏ hàng */
      .add_to_cart_button {
        margin-top: 0;  /* Bỏ margin top */
      }

      .search-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
      }

      .search-popup-content {
        position: relative;
        width: 95%;
        max-width: 1200px;
        margin: 30px auto;
        background-color: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      #searchInput {
        width: 100%;
        padding: 15px; /* Tăng padding */
        font-size: 16px;
        border: 2px solid #ddd; /* Tăng độ dày viền */
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .search-results {
        max-height: 75vh; /* Tăng chiều cao tối đa */
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 10px;
        background-color: white;
        width: 350px;
      }

      .search-item {
        padding: 12px 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .search-item:hover {
        background-color: #f8f8f8;
      }

      .search-item-content {
        display: flex;
        gap: 15px;
        min-height: 50px; /* Đảm bảo chiều cao tối thiểu bằng với ảnh */
      }

      .search-item-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
      }

      .search-item-details {
        flex: 1;
        display: flex;
        align-items: center;
      }

      .search-item-name {
        font-size: 15px;
        font-weight: 500;
        margin: 0;
        line-height: 1.4; /* Tăng line-height để dễ đọc khi xuống dòng */
        white-space: normal; /* Cho phép xuống dòng */
        overflow: visible; /* Cho phép hiển thị toàn bộ text */
        width: 100%;
        padding-right: 20px; /* Thêm padding bên phải để tránh text sát mép */
      }

      .search-item-price {
        font-size: 18px;
        color: #fe4c50;
        font-weight: bold;
      }

      .wavy-text {
    font-size: 24px;
    font-weight: bold;
    filter: url(#wavyFilter);
    display: inline-block;
}

svg {
    position: absolute;
    width: 0;
    height: 0;
}
    </style>
    
  </head>

  <body>
    <div class="super_container">
      <!-- Header -->

      <header class="header trans_300">
        <!-- Top Navigation -->

        <div class="top_nav">
          <div class="container">
            <div class="row">
              <div class="col-md-6">
                <div class="top_nav_left">Bán có tâm, Ắt có tầm</div>
              </div>
              <div class="col-md-6 text-right">
                <div class="top_nav_right">
                  <ul class="top_nav_menu">
                    

                    
                    <li class="language">
                      <a href="#">
                        Tiếng Việt
                        <i class="fa fa-angle-down"></i>
                      </a>
                      <ul class="language_selection">
                        <li><a href="#">Tiếng Việt</a></li>
                      </ul>
                    </li>
                    <li class="account">
                      <a href="#">
                        Tài khoản
                        <i class="fa fa-angle-down"></i>
                      </a>
                      <ul class="account_selection">
                        <li id="loginSection">
                          <a href="login.html">
                            <i class="fa fa-sign-in" aria-hidden="true"></i>Đăng nhập
                            
                          </a>
                        </li>
                        <li id="registerSection">
                          <a href="#">
                            <i class="fa fa-user-plus" aria-hidden="true"></i
                            >Đăng ký
                          </a>
                        </li>
                        <li id="userSection" style="display: none">
                          <a href="profile.html">
                            <i class="fa fa-user" aria-hidden="true"></i>
                            <span id="userFullName"></span>
                          </a>
                        </li>
                        <li id="logoutSection" style="display: none">
                          <a href="#" id="logoutBtn">
                            <i class="fa fa-sign-out" aria-hidden="true"> Đăng xuất</i
                            >
                          </a>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Navigation -->

        <div class="main_nav_container">
          <div class="container">
            <div class="row">
              <div class="col-lg-12 text-right">
                <div class="logo_container">
                  <a href="#">Tien<span>Tien </span></a>
                </div>
                <nav class="navbar">
                  <ul class="navbar_menu">
                    <li><a href="index.html">Trang chủ</a></li>
                    <li><a href="categories.html">danh mục </a></li>

                    <li><a href="contact.html">Liên hệ </a></li>
                  </ul>
                  <ul class="navbar_user">
                    <li>
                      <div class="search-container">
                        <input type="text" id="searchInput" placeholder="Tìm kiếm sản phẩm..." />
                        <div id="searchResults" class="search-results"></div>
                        
                    </div>
                    </li>
                    <li>
                      <a href="profile.html"
                        ><i class="fa fa-user" aria-hidden="true"></i
                      ></a>
                    </li>
                    <li class="checkout">
                      <a href="cart.html">
                        <i class="fa fa-shopping-cart" aria-hidden="true"></i>
                        <span id="checkout_items" class="checkout_items"
                          >0</span
                        >
                      </a>
                    </li>
                  </ul>
                  <div class="hamburger_container">
                    <i class="fa fa-bars" aria-hidden="true"></i>
                  </div>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </header>


      <!-- Slider -->

      <div
        class="main_slider"
        style="background-image: url(images/slider_1.jpg)"
      >
        <div class="container fill_height">
          <div class="row align-items-center fill_height">
            <div class="col">
              <div class="main_slider_content">
                <h6>Chào mừng đến với Tiên Tiên Shop</h6>
                <h1>Những sản phẩm chất lượng, bền bỉ cùng năm tháng</h1>
                <div class="red_button shop_now_button">
                  <a href="index.html">Mua ngay </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Banner -->

      <div class="banner">
        <div class="container">
          <div class="row" id="banner-container">
            
          </div>
        </div>
      </div>

      <div class="product-flex" id="haha" style="display: flex"></div>

      <!-- New Arrivals -->

      <div class="new_arrivals">
        <div class="container">
          <div class="row">
            <div class="col text-center">
              <div class="section_title new_arrivals_title">
                <h2>Sản phẩm mới</h2>
              </div>
            </div>
          </div>
          <div class="row align-items-center">
            <div class="col text-center">
              
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div
                class="product-grid"
                data-isotope='{ "itemSelector": ".product-item", "layoutMode": "fitRows" }'
              >
                <!-- Product 1 -->
                <!-- <div class="product-item men">
                  <div class="product discount product_filter">
                    <div class="product_image">
                      <img src="images/product_1.png" alt="" />
                    </div>
                    <div class="favorite favorite_left"></div>
                    <div
                      class="product_bubble product_bubble_right product_bubble_red d-flex flex-column align-items-center"
                    >
                      <span>-$20</span>
                    </div>
                    <div class="product_info">
                      <h6 class="product_name">
                        <a href="single.html"
                          >Fujifilm X100T 16 MP Digital Camera (Silver)</a
                        >
                      </h6>
                      <div class="product_price">
                        $520.00<span>$590.00</span>
                      </div>
                    </div>
                  </div>
                  <div class="red_button add_to_cart_button">
                    <button type="button" data-product-id="${product.id}" class="btn">
                        Thêm vào giỏ hàng
                    </button>
                  </div>
                </div> -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Deal of the week -->

      <div class="deal_ofthe_week">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-lg-6">
              <div class="deal_ofthe_week_img">
                <img src="images/Banner (2).png" alt="" />
              </div>
            </div>
            
          </div>
        </div>
      </div>

      <!-- Best Sellers -->

      <div class="best_sellers">
        <div class="container">
          <div class="row">
            <div class="col text-center">
              <div class="section_title new_arrivals_title">
                <h2>Bán chạy nhất</h2>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div class="product_slider_container">
                <div class="owl-carousel owl-theme product_slider">

                  <!-- Slide 10 -->

                  <div class="owl-item product_slider_item">
                    <div class="product-item men">
                      <div class="product">
                        <div class="product_image">
                          <img src="images/product_10.png" alt="" />
                        </div>
                        <div class="favorite"></div>
                        <div class="product_info">
                          <h6 class="product_name">
                            <a href="single.html"
                              >Pryma Headphones, Rose Gold & Grey</a
                            >
                          </h6>
                          <div class="product_price">$180.00</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Slider Navigation -->

                <div
                  class="product_slider_nav_left product_slider_nav d-flex align-items-center justify-content-center flex-column"
                >
                  <i class="fa fa-chevron-left" aria-hidden="true"></i>
                </div>
                <div
                  class="product_slider_nav_right product_slider_nav d-flex align-items-center justify-content-center flex-column"
                >
                  <i class="fa fa-chevron-right" aria-hidden="true"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Benefit -->

      <div class="benefit">
        <div class="container">
          <div class="row benefit_row">
            <div class="col-lg-3 benefit_col">
              <div class="benefit_item d-flex flex-row align-items-center">
                <div class="benefit_icon">
                  <i class="fa fa-truck" aria-hidden="true"></i>
                </div>
                <div class="benefit_content">
                  <h6 style="font-family: Arial;">Miễn phí ship</h6>
                  <p>Dịch vụ tốt, có tâm</p>
                </div>
              </div>
            </div>
            <div class="col-lg-3 benefit_col">
              <div class="benefit_item d-flex flex-row align-items-center">
                <div class="benefit_icon">
                  <i class="fa fa-money" aria-hidden="true"></i>
                </div>
                <div class="benefit_content">
                  <h6>Thanh toán tại nhà</h6>
                  <p>Xem trước khi thanh toán</p>
                </div>
              </div>
            </div>
            <div class="col-lg-3 benefit_col">
              <div class="benefit_item d-flex flex-row align-items-center">
                <div class="benefit_icon">
                  <i class="fa fa-undo" aria-hidden="true"></i>
                </div>
                <div class="benefit_content">
                  <h6>7 ngày hoàn trả</h6>
                  <p>Uy tín, chất lượng</p>
                </div>
              </div>
            </div>
            <div class="col-lg-3 benefit_col">
              <div class="benefit_item d-flex flex-row align-items-center">
                <div class="benefit_icon">
                  <i class="fa fa-clock-o" aria-hidden="true"></i>
                </div>
                <div class="benefit_content">
                  <h6>Mở cửa</h6>
                  <p>8AM - 09PM</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      

      <!-- Newsletter -->

      <!-- <div class="newsletter">
        <div class="container">
          <div class="row">
            <div class="col-lg-6">
              <div
                class="newsletter_text d-flex flex-column justify-content-center align-items-lg-start align-items-md-center text-center"
              >
                <h4>Newsletter</h4>
                <p>
                  Subscribe to our newsletter and get 20% off your first
                  purchase
                </p>
              </div>
            </div>
            <div class="col-lg-6">
              <form action="post">
                <div
                  class="newsletter_form d-flex flex-md-row flex-column flex-xs-column align-items-center justify-content-lg-end justify-content-center"
                >
                  <input
                    id="newsletter_email"
                    type="email"
                    placeholder="Your email"
                    required="required"
                    data-error="Valid email is required."
                  />
                  <button
                    id="newsletter_submit"
                    type="submit"
                    class="newsletter_submit_btn trans_300"
                    value="Submit"
                  >
                    subscribe
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div> -->

      <!-- Footer -->

      <footer class="footer">
        <div class="container">
          <div class="row">
            <div class="col-lg-6">
              <div
                class="footer_nav_container d-flex flex-sm-row flex-column align-items-center justify-content-lg-start justify-content-center text-center"
              >
                <ul class="footer_nav">
                  <li><a href="#">Blog</a></li>
                  <li><a href="#">FAQs</a></li>
                  <li><a href="contact.html">Liên hệ</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-6">
              <div
                class="footer_social d-flex flex-row align-items-center justify-content-lg-end justify-content-center"
              >
                <ul>
                  <li>
                    <a href="#"
                      ><i class="fa fa-facebook" aria-hidden="true"></i
                    ></a>
                  </li>
                  <li>
                    <a href="#"
                      ><i class="fa fa-twitter" aria-hidden="true"></i
                    ></a>
                  </li>
                  <li>
                    <a href="#"
                      ><i class="fa fa-instagram" aria-hidden="true"></i
                    ></a>
                  </li>
                  <li>
                    <a href="#"
                      ><i class="fa fa-skype" aria-hidden="true"></i
                    ></a>
                  </li>
                  <li>
                    <a href="#"
                      ><i class="fa fa-pinterest" aria-hidden="true"></i
                    ></a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="footer_nav_container">
                <div class="cr">
                  ©2018 All Rights Reserverd. Made with
                  <i class="fa fa-heart-o" aria-hidden="true"></i> by
                  <a href="#">Colorlib</a> &amp; distributed by
                  <a href="https://themewagon.com">ThemeWagon</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- Add service -->
    <script src="js/Constant/urlAPI.js"></script>
    <script src="js/OtherService/TempService.js"></script>
    
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="styles/bootstrap4/popper.js"></script>
    <script src="styles/bootstrap4/bootstrap.min.js"></script>
    <script src="plugins/Isotope/isotope.pkgd.min.js"></script>
    <script src="plugins/OwlCarousel2-2.2.1/owl.carousel.js"></script>
    <script src="plugins/easing/easing.js"></script>
    <script src="js/custom.js"></script>
    <script src="js/cart.js"></script>
    <script>
      // Test xem scripts đã load
      console.log('All scripts loaded');
      console.log('jQuery version:', $.fn.jquery);
    </script>

    <script>
      const token = localStorage.getItem("token");

      $(document).ready(function () {
        get(getAllBrands, token, function (error, brands) {
          if (error) {
            console.error("Có lỗi xảy ra khi gọi API:", error);
            return;
          }

          console.log("Brands data:", brands); // Debug xem dữ liệu

          $("#banner-container").empty();

          $.each(brands, function (index, brand) {
            $("#banner-container").append(`
              <div>
                <div class="banner_item align-items-center" 
                     style="background-image: url('${brand.image }')">
                  <div class="banner_category">
                    <a href="categories.html?id=${brand.id}">${brand.brandName}</a>
                  </div>
                </div>
              </div>
            `);
          });

          // Khởi tạo slick slider
          $("#banner-container").slick({
            slidesToShow: 3,
            slidesToScroll: 1,
            prevArrow: $('.slider-prev'),
            nextArrow: $('.slider-next'),
            infinite: true,
            speed: 500,
            cssEase: 'ease-in-out',
            autoplay: true,
            autoplaySpeed: 3000,
            responsive: [
              {
                breakpoint: 992,
                settings: {
                  slidesToShow: 2
                }
              },
              {
                breakpoint: 768,
                settings: {
                  slidesToShow: 1
                }
              }
            ]
          });
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        get(getAllProductDetail, token, function (error, products) {
          if (error) {
            console.error("Có lỗi xảy ra khi gọi API:", error);
            return;
          }

          // Tạo mảng promises để lấy ảnh cho tất cả sản phẩm
          const imagePromises = products.map(
            (product) =>
              new Promise((resolve) => {
                get(
                  getProductImagesByDetailId + product.id,
                  token,
                  function (imgError, images) {
                    if (imgError || !images || images.length === 0) {
                      resolve({
                        productId: product.id,
                        imageUrl: "images/product_placeholder.jpg",
                      });
                    } else {
                      resolve({
                        productId: product.id,
                        imageUrl: images[0].url,
                      });
                    }
                  }
                );
              })
          );

          // Đợi tất cả ảnh được lấy về
          Promise.all(imagePromises).then((productImages) => {
            // Tạo map để lưu trữ URL ảnh theo productId
            const imageMap = new Map(
              productImages.map((item) => [item.productId, item.imageUrl])
            );

            // Hiển thị sản phẩm
            $.each(products, function (index, product) {
              console.log("product: ", product);
              // Lấy URL ảnh từ map
              const imageUrl =
                imageMap.get(product.id) || "images/product_placeholder.jpg";

              // Append each product item
              $(".product-grid").append(
                `<div class="product-item men">
                  <div class="product discount product_filter">
                    <div class="product_image">
                      <img src="${imageUrl}" alt="${product.name}">
                    </div>
                    
                    <div class="product_bubble product_bubble_right product_bubble_red d-flex flex-column align-items-center">
                      <span>New</span>
                    </div>
                    <div class="product_info">
                      <h6 class="product_name"><a href="single.html?id=${product.id}">${product.name}</a></h6>
                      <div class="product_price">${product.price?.toLocaleString("vi-VN")}đ</div>
                    </div>
                  </div>
                  <div class="red_button add_to_cart_button">
                    
                    <a href="#" class="add_to_cart_link" data-product-id="${product.id}" class="btn">Thêm vào giỏ hàng</a>
                  </div>
                </div>`
              );
            });

            // Sau khi thêm tất cả sản phẩm, khởi tạo lại Isotope
            $(".product-grid").isotope("reloadItems").isotope();
          });
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        // Kiểm tra trạng thái đăng nhập
        function checkLoginStatus() {
          const token = localStorage.getItem("token");
          const userRole = localStorage.getItem("userRole");
          const userName = localStorage.getItem("userName");

          if (token && userRole === "Customer") {
            // Đã đăng nhập
            $("#loginSection, #registerSection").hide();
            $("#userSection, #logoutSection").show();
            $("#userFullName").text(userName);
          } else {
            // Chưa đăng nhập
            $("#loginSection, #registerSection").show();
            $("#userSection, #logoutSection").hide();
          }
        }

        // Xử lý đăng xuất
        $("#logoutBtn").click(function (e) {
          e.preventDefault();

          // Xóa thông tin đăng nhập khỏi localStorage
          localStorage.removeItem("token");
          localStorage.removeItem("refreshToken");
          localStorage.removeItem("tokenExpiration");
          localStorage.removeItem("userId");
          localStorage.removeItem("userRole");
          localStorage.removeItem("userName");
          localStorage.removeItem("userEmail");

          // Chuyển hướng về trang đăng nhập
          window.location.href = "login.html";
        });

        // Kiểm tra trạng thái đăng nhập khi trang được tải
        checkLoginStatus();
      });
    </script>
    <script>
      $(document).on('click', '.add_to_cart_link', function(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('token');
        const customerId = localStorage.getItem('userId');
        
        if (!token || !customerId) {
            alert('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng!');
            window.location.href = 'login.html';
            return;
        }

        const productDetailId = $(this).data('product-id');
        console.log('ProductDetailId:', productDetailId); // Log để debug

        // Kiểm tra sản phẩm đã có trong giỏ hàng chưa
        $.ajax({
            url: `https://localhost:7060/api/Cart/get-cart/${customerId}`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function(cartResponse) {
                const existingItem = cartResponse.items.find(item => 
                    item.productDetailId === productDetailId
                );

                if (existingItem) {
                    // Nếu sản phẩm đã tồn tại, cập nhật số lượng
                    const updateData = {
                        cartDetailId: existingItem.cartDetailId,
                        quantity: existingItem.quantity + 1
                    };

                    $.ajax({
                        url: 'https://localhost:7060/api/Cart/update-quantity',
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(updateData),
                        success: function(response) {
                            alert('Đã cập nhật số lượng trong giỏ hàng!');
                            updateCartCount();
                        },
                        error: function(xhr) {
                            console.error('Lỗi khi cập nhật số lượng:', xhr);
                            alert('Không thể cập nhật số lượng. Vui lòng thử lại sau.');
                        }
                    });
                } else {
                    // Nếu sản phẩm chưa có trong giỏ hàng, thêm mới
                    const cartData = {
                        productDetailId: parseInt(productDetailId), // Đảm bảo là số
                        quantity: 1,
                        customerId: parseInt(customerId)
                    };

                    console.log('Dữ liệu gửi đi:', cartData); // Log để debug

                    $.ajax({
                        url: 'https://localhost:7060/api/Cart/add-to-cart',
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(cartData),
                        success: function(response) {
                            alert('Thêm vào giỏ hàng thành công!');
                            updateCartCount();
                        },
                        error: function(xhr) {
                            console.error('Lỗi khi thêm vào giỏ hàng:', xhr);
                            let errorMessage = 'Không thể thêm vào giỏ hàng. ';
                            
                            if (xhr.responseText) {
                                try {
                                    const errorResponse = JSON.parse(xhr.responseText);
                                    errorMessage += errorResponse.message || 'Vui lòng thử lại sau.';
                                } catch (e) {
                                    errorMessage += 'Vui lòng thử lại sau.';
                                }
                            }
                            
                            alert(errorMessage);
                        }
                    });
                }
            },
            error: function(xhr) {
                console.error('Lỗi khi kiểm tra giỏ hàng:', xhr);
                if (xhr.status === 401) {
                    alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                    window.location.href = 'login.html';
                } else {
                    alert('Không thể kiểm tra giỏ hàng. Vui lòng thử lại sau.');
                }
            }
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        // Show popup when clicking search icon
        $("#searchIcon").click(function(e) {
          e.preventDefault();
          $("#searchPopup").fadeIn(200);
          $("#searchInput").focus();
        });

        // Close popup when clicking outside
        $("#searchPopup").click(function(e) {
          if ($(e.target).is("#searchPopup")) {
            $(this).fadeOut(200);
          }
        });

        // Search functionality
        let searchTimeout; // Thêm biến để debounce
        
        $("#searchInput").on("input", function () {
          const query = $(this).val();
          const token = localStorage.getItem("token");

          // Clear previous timeout
          clearTimeout(searchTimeout);

          if (query.length > 0) {
            // Set new timeout
            searchTimeout = setTimeout(() => {
              $.ajax({
                url: `https://localhost:7060/api/ProductDetail/FindByName/${query}`,
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`
                },
                success: function(products) {
                  $("#searchResults").empty(); // Xóa kết quả cũ
                  
                  if (products && products.length > 0) {
                    const processedProducts = new Set(); // Theo dõi sản phẩm đã xử lý

                    products.forEach(product => {
                      // Kiểm tra nếu sản phẩm đã được xử lý
                      if (!processedProducts.has(product.id)) {
                        processedProducts.add(product.id); // Đánh dấu là đã xử lý

                        $.ajax({
                          url: `https://localhost:7060/api/ProductImage/productDetailId/${product.id}`,
                          method: 'GET',
                          headers: {
                            'Authorization': `Bearer ${token}`
                          },
                          success: function(images) {
                            const imageUrl = images && images.length > 0 
                              ? images[0].url 
                              : 'images/product_placeholder.jpg';
                            
                            const productHtml = `
                              <div class="search-item" data-id="${product.id}">
                                <div class="search-item-content">
                                  <img src="${imageUrl}" alt="${product.name}" class="search-item-image">
                                  <div class="search-item-details">
                                    <div class="search-item-name">${product.name}</div>
                                  </div>
                                </div>
                              </div>
                            `;
                            
                            $("#searchResults").append(productHtml);
                          },
                          error: function() {
                            // Nếu không lấy được ảnh, vẫn hiển thị sản phẩm với ảnh mặc định
                            const productHtml = `
                              <div class="search-item" data-id="${product.id}">
                                <div class="search-item-content">
                                  <img src="images/product_placeholder.jpg" alt="${product.name}" class="search-item-image">
                                  <div class="search-item-details">
                                    <div class="search-item-name">${product.name}</div>
                                  </div>
                                </div>
                              </div>
                            `;
                            
                            $("#searchResults").append(productHtml);
                          }
                        });
                      }
                    });
                    
                    $("#searchResults").show();
                  } else {
                    $("#searchResults").html('<div class="search-item">Không tìm thấy sản phẩm</div>');
                    $("#searchResults").show();
                  }
                },
                error: function(xhr) {
                  console.error("Lỗi khi tìm kiếm:", xhr);
                  $("#searchResults").html('<div class="search-item">Đã xảy ra lỗi khi tìm kiếm</div>');
                  $("#searchResults").show();
                }
              });
            }, 300); // Đợi 300ms sau khi người dùng ngừng gõ
          } else {
            $("#searchResults").hide();
          }
        });

        // Handle product click
        $(document).on("click", ".search-item", function () {
          const productId = $(this).data("id");
          window.location.href = `single.html?id=${productId}`;
        });

        // Clear search when popup closes
        $("#searchPopup").on("hidden", function() {
          $("#searchInput").val("");
          $("#searchResults").hide();
        });
      });
    </script>
    <script>
      function loadBestSellers() {
    const token = localStorage.getItem('token');

    $.ajax({
        url: 'https://localhost:7060/api/BestSeller/GetAll',
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        success: function (bestSellers) {
            if (!bestSellers || bestSellers.length === 0) {
                $('.product_slider').html('<p>Không có sản phẩm bán chạy</p>');
                return;
            }

            const detailPromises = bestSellers.map(bestSeller =>
                new Promise((resolve) => {
                    $.ajax({
                        url: `https://localhost:7060/api/ProductDetail/findId/${bestSeller.productDetailId}`,
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${token}` },
                        success: function (productDetail) {
                            $.ajax({
                                url: `https://localhost:7060/api/ProductImage/productDetailId/${bestSeller.productDetailId}`,
                                method: 'GET',
                                headers: { 'Authorization': `Bearer ${token}` },
                                success: function (images) {
                                    resolve({
                                        ...productDetail,
                                        imageUrl: images && images.length > 0 ? images[0].url : 'images/product_placeholder.jpg'
                                    });
                                },
                                error: function () {
                                    resolve({
                                        ...productDetail,
                                        imageUrl: 'images/product_placeholder.jpg'
                                    });
                                }
                            });
                        },
                        error: function () {
                            resolve(null);
                        }
                    });
                })
            );

            Promise.all(detailPromises).then(products => {
                const validProducts = products.filter(p => p !== null);
                const $slider = $('.product_slider');

                // Xóa nội dung cũ
                $slider.empty();

                validProducts.forEach(product => {
                    const priceFormatted = product.price ? `${product.price.toLocaleString('vi-VN')}đ` : 'Liên hệ';
                    $slider.append(`
                        <div class="owl-item product_slider_item">
                            <div class="product-item men">
                                
                                    <div class="product">
                                        <div class="product_image">
                                            <img src="${product.imageUrl}" alt="${product.name}">
                                            
                                        </div>
                                        <div class="product_bubble product_bubble_right product_bubble_red d-flex flex-column align-items-center">
                                          <span >HOT</span>
                                        </div>
                                        <svg>
    <filter id="wavyFilter">
        <feTurbulence type="fractalNoise" baseFrequency="0.02 0.1" numOctaves="1" result="warp" />
        <feDisplacementMap in="SourceGraphic" in2="warp" scale="10" />
    </filter>
</svg>
                                        <a href="single.html?id=${product.id}" class="product-link">
                                          <div class="product_info text-center">
                                            <h6 class="product_name">${product.name}</h6>
                                            <div class="product_price">${priceFormatted}</div>
                                          </div>
                                        </a>
                                        <div class="red_button add_to_cart_button">
                                          <a href="#" class="add_to_cart_link" data-product-id="${product.id}" class="btn">Thêm vào giỏ hàng</a>
                                        </div>
                                    </div>
                                
                                
                            </div>
                        </div>
                    `);
                });

                // Khởi tạo lại Owl Carousel
                $slider.owlCarousel('destroy'); // Xóa carousel cũ
                $slider.owlCarousel({
                    items: 4,
                    margin: 15,
                    
                    loop: true,
                    nav: false,
                    dots: true,
                    autoplay: false,
                    autoHeight: true,
                    navText: [
                        '<i class="fa fa-chevron-left" aria-hidden="true"></i>',
                        '<i class="fa fa-chevron-right" aria-hidden="true"></i>'
                    ],
                    responsive: {
                        0: { items: 1 },
                        576: { items: 2 },
                        768: { items: 3 },
                        992: { items: 4 }
                    }
                });
            });
        },
        error: function (xhr) {
            console.error('Lỗi khi lấy danh sách best sellers:', xhr);
            $('.product_slider').html('<p>Có lỗi xảy ra khi tải sản phẩm bán chạy</p>');
        }
    });
}

$(document).ready(function () {
    loadBestSellers();
});
  </script>
  
    
  </body>
</html>

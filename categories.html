<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Colo Shop Categories</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description" content="Colo Shop Template" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      type="text/css"
      href="styles/bootstrap4/bootstrap.min.css"
    />
    <link
      href="plugins/font-awesome-4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="plugins/OwlCarousel2-2.2.1/owl.carousel.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="plugins/OwlCarousel2-2.2.1/owl.theme.default.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="plugins/OwlCarousel2-2.2.1/animate.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="plugins/jquery-ui-1.12.1.custom/jquery-ui.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="styles/categories_styles.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="styles/categories_responsive.css"
    />
    <style>
      
      .product_image {
        width: 100%;
        height: 250px;  /* Chiều cao cố định cho tất cả ảnh */
        overflow: hidden;
        position: relative;
      }

      .product_image img {
        width: 100%;
        height: 100%;
        object-fit: cover;  /* Giữ tỷ lệ ảnh và cắt phần thừa */
        object-position: center;  /* Căn giữa ảnh */
      }

      
      .search-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
      }

      .search-popup-content {
        position: relative;
        width: 95%;
        max-width: 1200px;
        margin: 30px auto;
        background-color: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      #searchInput {
        width: 100%;
        padding: 15px; /* Tăng padding */
        font-size: 16px;
        border: 2px solid #ddd; /* Tăng độ dày viền */
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .search-results {
        max-height: 75vh; /* Tăng chiều cao tối đa */
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 10px;
        background-color: white;
      }

      .search-item {
        padding: 12px 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .search-item:hover {
        background-color: #f8f8f8;
      }

      .search-item-content {
        display: flex;
        gap: 15px;
        min-height: 50px; /* Đảm bảo chiều cao tối thiểu bằng với ảnh */
      }

      .search-item-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
      }

      .search-item-details {
        flex: 1;
        display: flex;
        align-items: center;
      }

      .search-item-name {
        font-size: 15px;
        font-weight: 500;
        margin: 0;
        line-height: 1.4; /* Tăng line-height để dễ đọc khi xuống dòng */
        white-space: normal; /* Cho phép xuống dòng */
        overflow: visible; /* Cho phép hiển thị toàn bộ text */
        width: 100%;
        padding-right: 20px; /* Thêm padding bên phải để tránh text sát mép */
      }

      .search-item-price {
        font-size: 18px;
        color: #fe4c50;
        font-weight: bold;
      }

      .search-container {
        position: relative;
      }

      #searchInput {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        width: 350px;
        max-height: 75vh;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 10px;
        background-color: white;
        z-index: 1000;
        display: none;
      }

      .search-item {
        padding: 12px 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .search-item:hover {
        background-color: #f8f8f8;
      }

      .search-item-content {
        display: flex;
        gap: 15px;
        min-height: 50px;
      }

      .search-item-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
      }

      .search-item-details {
        flex: 1;
        display: flex;
        align-items: center;
      }

      .search-item-name {
        font-size: 15px;
        font-weight: 500;
        margin: 0;
        line-height: 1.4;
        white-space: normal;
        overflow: visible;
        width: 100%;
        padding-right: 20px;
      }
    </style>
  </head>

  <body>
    <div class="super_container">
      <!-- Header -->

      <header class="header trans_300">
        <!-- Top Navigation -->

        <div class="top_nav">
          <div class="container">
            <div class="row">
              <div class="col-md-6">
                <div class="top_nav_left">Bán có tâm, Ắt có tầm</div>
              </div>
              <div class="col-md-6 text-right">
                <div class="top_nav_right">
                  <ul class="top_nav_menu">
                    

                    
                    <li class="language">
                      <a href="#">
                        Tiếng Việt
                        <i class="fa fa-angle-down"></i>
                      </a>
                      <ul class="language_selection">
                        <li><a href="#">Tiếng Việt</a></li>
                      </ul>
                    </li>
                    <li class="account">
                      <a href="#">
                        Tài khoản
                        <i class="fa fa-angle-down"></i>
                      </a>
                      <ul class="account_selection">
                        <li id="loginSection">
                          <a href="login.html">
                            <i class="fa fa-sign-in" aria-hidden="true"></i>Đăng nhập
                            
                          </a>
                        </li>
                        <li id="registerSection">
                          <a href="#">
                            <i class="fa fa-user-plus" aria-hidden="true"></i
                            >Đăng ký
                          </a>
                        </li>
                        <li id="userSection" style="display: none">
                          <a href="profile.html">
                            <i class="fa fa-user" aria-hidden="true"></i>
                            <span id="userFullName"></span>
                          </a>
                        </li>
                        <li id="logoutSection" style="display: none">
                          <a href="#" id="logoutBtn">
                            <i class="fa fa-sign-out" aria-hidden="true"> Đăng xuất</i
                            >
                          </a>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Navigation -->

        <div class="main_nav_container">
          <div class="container">
            <div class="row">
              <div class="col-lg-12 text-right">
                <div class="logo_container">
                  <a href="index.html">Tien<span>Tien </span></a>
                </div>
                <nav class="navbar">
                  <ul class="navbar_menu">
                    <li><a href="index.html">Trang chủ</a></li>
                    <li><a href="categories.html">danh mục </a></li>

                    <li><a href="contact.html">Liên hệ </a></li>
                  </ul>
                  <ul class="navbar_user">
                    <li>
                      <div class="search-container">
                        <input type="text" id="searchInput" placeholder="Tìm kiếm sản phẩm..." />
                        <div id="searchResults" class="search-results"></div>
                      </div>
                    </li>
                    <li>
                      <a href="profile.html"
                        ><i class="fa fa-user" aria-hidden="true"></i
                      ></a>
                    </li>
                    <li class="checkout">
                      <a href="cart.html">
                        <i class="fa fa-shopping-cart" aria-hidden="true"></i>
                        <span id="checkout_items" class="checkout_items"
                          >0</span
                        >
                      </a>
                    </li>
                  </ul>
                  <div class="hamburger_container">
                    <i class="fa fa-bars" aria-hidden="true"></i>
                  </div>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="fs_menu_overlay"></div>

      <!-- Hamburger Menu -->

      <div class="hamburger_menu">
        <div class="hamburger_close">
          <i class="fa fa-times" aria-hidden="true"></i>
        </div>
        <div class="hamburger_menu_content text-right">
          <ul class="menu_top_nav">
            <li class="menu_item has-children">
              <a href="#">
                usd
                <i class="fa fa-angle-down"></i>
              </a>
              <ul class="menu_selection">
                <li><a href="#">cad</a></li>
                <li><a href="#">aud</a></li>
                <li><a href="#">eur</a></li>
                <li><a href="#">gbp</a></li>
              </ul>
            </li>
            <li class="menu_item has-children">
              <a href="#">
                English
                <i class="fa fa-angle-down"></i>
              </a>
              <ul class="menu_selection">
                <li><a href="#">French</a></li>
                <li><a href="#">Italian</a></li>
                <li><a href="#">German</a></li>
                <li><a href="#">Spanish</a></li>
              </ul>
            </li>
            <li class="menu_item has-children">
              <a href="#">
                My Account
                <i class="fa fa-angle-down"></i>
              </a>
              <ul class="menu_selection">
                <li>
                  <a href="#"
                    ><i class="fa fa-sign-in" aria-hidden="true"></i>Sign In</a
                  >
                </li>
                <li>
                  <a href="#"
                    ><i class="fa fa-user-plus" aria-hidden="true"></i
                    >Register</a
                  >
                </li>
              </ul>
            </li>
            <li class="menu_item"><a href="#">home</a></li>
            <li class="menu_item"><a href="#">shop</a></li>
            <li class="menu_item"><a href="#">promotion</a></li>
            <li class="menu_item"><a href="#">pages</a></li>
            <li class="menu_item"><a href="#">blog</a></li>
            <li class="menu_item"><a href="#">contact</a></li>
          </ul>
        </div>
      </div>

      <div class="container product_section_container">
        <div class="row">
          <div class="col product_section clearfix">
            <!-- Breadcrumbs -->

            <div class="breadcrumbs d-flex flex-row align-items-center">
              <ul>
                <li><a href="index.html">Home</a></li>
                
                <li class="active">
                  <a href="categories.html"
                    ><i class="fa fa-angle-right" aria-hidden="true"></i>Danh mục</a
                  >
                </li>
              </ul>
            </div>

            <!-- Sidebar -->

            <div class="sidebar">
              <div class="sidebar_section">
                <div class="sidebar_title">
                  <h5>Thương hiệu</h5>
                </div>
                <ul class="sidebar_categories" id="brandList">
                  <!-- Brands sẽ được thêm vào đây bằng JavaScript -->
                </ul>
              </div>

              <!-- Price Range Filtering -->
              <div class="sidebar_section">
                <div class="sidebar_title">
                  <h5>Tìm kiếm theo giá</h5>
                </div>
                <p>
                  <input
                    type="text"
                    id="amount"
                    readonly
                    style="border: 0; color: #f6931f; font-weight: bold"
                  />
                </p>
                <div id="slider-range"></div>
                <div class="filter_button"><span>Tìm kiếm</span></div>
              </div>

              <!-- Sizes -->
              <div class="sidebar_section">
                <div class="sidebar_title">
                  <h5></h5>
                </div>
                <ul class="checkboxes">
                  <!-- <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>S</span>
                  </li>
                  <li class="active">
                    <i class="fa fa-square" aria-hidden="true"></i
                    ><span>M</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>L</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>XL</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>XXL</span>
                  </li> -->
                </ul>
              </div>

              <!-- Color -->
              <div class="sidebar_section">
                <div class="sidebar_title">
                  <h5></h5>
                </div>
                <ul class="checkboxes">
                  <!-- <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>Black</span>
                  </li>
                  <li class="active">
                    <i class="fa fa-square" aria-hidden="true"></i
                    ><span>Pink</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>White</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>Blue</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>Orange</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>White</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>Blue</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>Orange</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>White</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>Blue</span>
                  </li>
                  <li>
                    <i class="fa fa-square-o" aria-hidden="true"></i
                    ><span>Orange</span>
                  </li> -->
                </ul>
                <div class="show_more">
                  <!-- <span><span>+</span>Show More</span> -->
                </div>
              </div>
            </div>

            <!-- Main Content -->

            <div class="main_content">
              <!-- Products -->

              <div class="products_iso">
                <div class="row">
                  <div class="col">
                    <!-- Product Sorting -->

                    <div
                      class="product_sorting_container product_sorting_container_top"
                    >
                      <ul class="product_sorting">
                        <li>
                          <span class="type_sorting_text">Mặc định</span>
                          <i class="fa fa-angle-down"></i>
                          <ul class="sorting_type">
                            <li
                              class="type_sorting_btn"
                              data-isotope-option='{ "sortBy": "original-order" }'
                            >
                              <span>Mặc định</span>
                            </li>
                            <li
                              class="type_sorting_btn"
                              data-isotope-option='{ "sortBy": "price" }'
                            >
                              <span>Giá</span>
                            </li>
                            
                          </ul>
                        </li>
                        <li>
                          <span>Hiển thị</span>
                          <span class="num_sorting_text">6</span>
                          <i class="fa fa-angle-down"></i>
                          <ul class="sorting_num">
                            <li class="num_sorting_btn"><span>6</span></li>
                            <li class="num_sorting_btn"><span>12</span></li>
                            
                          </ul>
                        </li>
                      </ul>
                      <div class="pages d-flex flex-row align-items-center">
                        <div class="page_current">
                          <span>1</span>
                          <ul class="page_selection">
                            <li><a href="#">1</a></li>
                            <li><a href="#">2</a></li>
                            <li><a href="#">3</a></li>
                          </ul>
                        </div>
                        <div class="page_total"><span>of</span> 3</div>
                        <div id="next_page" class="page_next">
                          <a href="#"
                            ><i
                              class="fa fa-long-arrow-right"
                              aria-hidden="true"
                            ></i
                          ></a>
                        </div>
                      </div>
                    </div>

                    <!-- Product Grid -->

                    <div class="product-grid">
                      <!-- Product 1 -->

                      
                    </div>

                    <!-- Product Sorting -->

                    <div
                      class="product_sorting_container product_sorting_container_bottom clearfix"
                    >
                      <ul class="product_sorting">
                        <li>
                          <span>Show:</span>
                          <span class="num_sorting_text">04</span>
                          <i class="fa fa-angle-down"></i>
                          <ul class="sorting_num">
                            <li class="num_sorting_btn"><span>01</span></li>
                            <li class="num_sorting_btn"><span>02</span></li>
                            <li class="num_sorting_btn"><span>03</span></li>
                            <li class="num_sorting_btn"><span>04</span></li>
                          </ul>
                        </li>
                      </ul>
                      <span class="showing_results"
                        >Showing 1–3 of 12 results</span
                      >
                      <div class="pages d-flex flex-row align-items-center">
                        <div class="page_current">
                          <span>1</span>
                          <ul class="page_selection">
                            <li><a href="#">1</a></li>
                            <li><a href="#">2</a></li>
                            <li><a href="#">3</a></li>
                          </ul>
                        </div>
                        <div class="page_total"><span>of</span> 3</div>
                        <div id="next_page_1" class="page_next">
                          <a href="#"
                            ><i
                              class="fa fa-long-arrow-right"
                              aria-hidden="true"
                            ></i
                          ></a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Benefit -->

      <div class="benefit">
        <div class="container">
          <div class="row benefit_row">
            <div class="col-lg-3 benefit_col">
              <div class="benefit_item d-flex flex-row align-items-center">
                <div class="benefit_icon">
                  <i class="fa fa-truck" aria-hidden="true"></i>
                </div>
                <div class="benefit_content">
                  <h6 style="font-family: Arial;">Miễn phí ship</h6>
                  <p>Dịch vụ tốt, có tâm</p>
                </div>
              </div>
            </div>
            <div class="col-lg-3 benefit_col">
              <div class="benefit_item d-flex flex-row align-items-center">
                <div class="benefit_icon">
                  <i class="fa fa-money" aria-hidden="true"></i>
                </div>
                <div class="benefit_content">
                  <h6>Thanh toán tại nhà</h6>
                  <p>Xem trước khi thanh toán</p>
                </div>
              </div>
            </div>
            <div class="col-lg-3 benefit_col">
              <div class="benefit_item d-flex flex-row align-items-center">
                <div class="benefit_icon">
                  <i class="fa fa-undo" aria-hidden="true"></i>
                </div>
                <div class="benefit_content">
                  <h6>7 ngày hoàn trả</h6>
                  <p>Uy tín, chất lượng</p>
                </div>
              </div>
            </div>
            <div class="col-lg-3 benefit_col">
              <div class="benefit_item d-flex flex-row align-items-center">
                <div class="benefit_icon">
                  <i class="fa fa-clock-o" aria-hidden="true"></i>
                </div>
                <div class="benefit_content">
                  <h6>Mở cửa</h6>
                  <p>8AM - 09PM</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      

      <!-- Footer -->

      <footer class="footer">
        <div class="container">
          <div class="row">
            <div class="col-lg-6">
              <div
                class="footer_nav_container d-flex flex-sm-row flex-column align-items-center justify-content-lg-start justify-content-center text-center"
              >
                <ul class="footer_nav">
                  <li><a href="#">Blog</a></li>
                  <li><a href="#">FAQs</a></li>
                  <li><a href="contact.html">Contact us</a></li>
                </ul>
              </div>
            </div>
            <div class="col-lg-6">
              <div
                class="footer_social d-flex flex-row align-items-center justify-content-lg-end justify-content-center"
              >
                <ul>
                  <li>
                    <a href="#"
                      ><i class="fa fa-facebook" aria-hidden="true"></i
                    ></a>
                  </li>
                  <li>
                    <a href="#"
                      ><i class="fa fa-twitter" aria-hidden="true"></i
                    ></a>
                  </li>
                  <li>
                    <a href="#"
                      ><i class="fa fa-instagram" aria-hidden="true"></i
                    ></a>
                  </li>
                  <li>
                    <a href="#"
                      ><i class="fa fa-skype" aria-hidden="true"></i
                    ></a>
                  </li>
                  <li>
                    <a href="#"
                      ><i class="fa fa-pinterest" aria-hidden="true"></i
                    ></a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="footer_nav_container">
                <div class="cr">
                  ©2018 All Rights Reserverd. Template by
                  <a href="#">Colorlib</a> &amp; distributed by
                  <a href="https://themewagon.com">ThemeWagon</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- Scripts -->
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="styles/bootstrap4/popper.js"></script>
    <script src="styles/bootstrap4/bootstrap.min.js"></script>
    <script src="plugins/Isotope/isotope.pkgd.min.js"></script>
    <script src="plugins/OwlCarousel2-2.2.1/owl.carousel.js"></script>
    <script src="plugins/easing/easing.js"></script>
    <script src="plugins/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
    <!-- Import TempService trước khi sử dụng hàm get -->
    <script src="js/Constant/urlAPI.js"></script>
    <script src="js/categories_custom.js"></script>
    <script>
      $(document).ready(function () {
        // Kiểm tra trạng thái đăng nhập
        function checkLoginStatus() {
          const token = localStorage.getItem("token");
          const userRole = localStorage.getItem("userRole");
          const userName = localStorage.getItem("userName");

          if (token && userRole === "Customer") {
            // Đã đăng nhập
            $("#loginSection, #registerSection").hide();
            $("#userSection, #logoutSection").show();
            $("#userFullName").text(userName);
          } else {
            // Chưa đăng nhập
            $("#loginSection, #registerSection").show();
            $("#userSection, #logoutSection").hide();
          }
        }

        // Xử lý đăng xuất
        $("#logoutBtn").click(function (e) {
          e.preventDefault();

          // Xóa thông tin đăng nhập khỏi localStorage
          localStorage.removeItem("token");
          localStorage.removeItem("refreshToken");
          localStorage.removeItem("tokenExpiration");
          localStorage.removeItem("userId");
          localStorage.removeItem("userRole");
          localStorage.removeItem("userName");
          localStorage.removeItem("userEmail");

          // Chuyển hướng về trang đăng nhập
          window.location.href = "login.html";
        });

        // Kiểm tra trạng thái đăng nhập khi trang được tải
        checkLoginStatus();
      });
    </script>
    <script>
      $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const urlBrandId = parseInt(urlParams.get("id")) || 0;
        const token = localStorage.getItem("token"); // Thay thế bằng token thực tế
        const getAllBrands = "https://localhost:7060/api/Brand/GetAll"; 
        const getProductByBrandId = "https://localhost:7060/api/Product/find-product-byBrandId/";
        const getAllProductDetail = "https://localhost:7060/api/ProductDetail/GetAll";
        const getProductImagesByDetailId = "https://localhost:7060/api/ProductImage/productDetailId/";
    
        // Lấy danh sách brands và hiển thị
        $.ajax({
          url: getAllBrands,
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/json",
            "Content-Type": "application/json"
          },
          success: function (brands) {
            let brandsHtml = `<li ${urlBrandId === 0 ? 'class="active"' : ""}>
              <a href="#" data-brand-id="0">All</a>
            </li>`;
    
            brands.forEach((brand) => {
              brandsHtml += `
                <li ${urlBrandId === brand.id ? 'class="active"' : ""}>
                  <a href="#" data-brand-id="${brand.id}">${brand.brandName}</a>
                </li>`;
            });
    
            $("#brandList").html(brandsHtml);
    
            // Xử lý sự kiện click brand
            $("#brandList li a").click(function (e) {
              e.preventDefault();
              const brandId = $(this).data("brand-id");
    
              $("#brandList li").removeClass("active");
              $(this).parent().addClass("active");
    
              if (brandId === 0) {
                window.history.pushState({}, "", "categories.html");
              } else {
                window.history.pushState({}, "", `categories.html?id=${brandId}`);
              }
    
              loadProductsByBrand(brandId);
            });
    
            // Load sản phẩm dựa trên brandId từ URL
            loadProductsByBrand(urlBrandId);
          },
          error: function (error) {
            console.error("Lỗi khi lấy brands:", error);
          }
        });
    
        function loadProductsByBrand(brandId) {
          const token = localStorage.getItem("token");
          
          if (brandId === 0) {
            // Nếu chọn All, lấy trực tiếp từ ProductDetail
            $.ajax({
              url: getAllProductDetail,
              method: "GET",
              headers: {
                "Authorization": `Bearer ${token}`
              },
              success: function(products) {
                displayProducts(products, true); // true indicates data is from ProductDetail
              },
              error: function(error) {
                console.error("Lỗi khi lấy sản phẩm:", error);
              }
            });
          } else {
            // Nếu chọn brand cụ thể
            $.ajax({
              url: `${getProductByBrandId}${brandId}`,
              method: "GET",
              headers: {
                "Authorization": `Bearer ${token}`
              },
              success: function(products) {
                // Lấy ProductDetail cho mỗi Product
                const detailPromises = products.map(product => 
                  new Promise((resolve) => {
                    $.ajax({
                      url: `https://localhost:7060/api/ProductDetail/productId/${product.id}`,
                      method: "GET",
                      headers: {
                        "Authorization": `Bearer ${token}`
                      },
                      success: function(details) {
                        resolve(details);
                      },
                      error: function() {
                        resolve([]);
                      }
                    });
                  })
                );

                Promise.all(detailPromises).then(productDetailsArray => {
                  // Làm phẳng mảng các ProductDetail và loại bỏ mảng rỗng
                  const allProductDetails = productDetailsArray
                    .flat()
                    .filter(detail => detail !== null && detail !== undefined);
                  
                  displayProducts(allProductDetails, true);
                });
              },
              error: function(error) {
                console.error("Lỗi khi lấy sản phẩm theo brand:", error);
              }
            });
          }
        }
    
        function displayProducts(products, isProductDetail = true) {
          if (!products || products.length === 0) {
            $(".product-grid").html('<div class="no-products">Không có sản phẩm nào</div>');
            return;
          }

          const imagePromises = products.map(product =>
            new Promise(resolve => {
              $.ajax({
                url: `${getProductImagesByDetailId}${product.id}`,
                method: "GET",
                headers: {
                  "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                success: function(images) {
                  resolve({
                    productId: product.id,
                    imageUrl: images && images.length > 0 ? images[0].url : "images/product_placeholder.jpg"
                  });
                },
                error: function() {
                  resolve({
                    productId: product.id,
                    imageUrl: "images/product_placeholder.jpg"
                  });
                }
              });
            })
          );

          Promise.all(imagePromises).then(productImages => {
            const imageMap = new Map(productImages.map(item => [item.productId, item.imageUrl]));

            $(".product-grid").html("");
            products.forEach(product => {
              $(".product-grid").append(`
                <div class="product-item men">
                  <div class="product discount product_filter">
                    <div class="product_image">
                      <img src="${imageMap.get(product.id)}" alt="${product.name}">
                    </div>
                    <div class="product_info">
                      <h6 class="product_name">
                        <a href="single.html?id=${product.id}">${product.name}</a>
                      </h6>
                      <div class="product_price">${product.price?.toLocaleString("vi-VN")}đ</div>
                    </div>
                  </div>
                  <div class="red_button add_to_cart_button">
                    
                    <a href="#" class="add_to_cart_link" data-product-id="${product.id}" class="btn">Thêm vào giỏ hàng</a>
                  </div>
                </div>
              `);
            });

            $(".product-grid").isotope("reloadItems").isotope();
          });
        }
      });
    </script>
    <script>
$(document).ready(function() {
  updateCartCount();
  function updateCartCount() {
          const token = localStorage.getItem('token');
          const customerId = localStorage.getItem('userId');
          
          if (!token || !customerId) return;
  
          $.ajax({
              url: `https://localhost:7060/api/Cart/get-cart/${customerId}`,
              method: 'GET',
              headers: {
                  'Authorization': `Bearer ${token}`
              },
              success: function(response) {
                  const totalItems = response.items.reduce((sum, item) => sum + item.quantity, 0);
                  $('#checkout_items').text(totalItems);
              }
          });
      }
      $(document).on('click', '.add_to_cart_link ', function(e) {
        e.preventDefault();
        
        const token = localStorage.getItem('token');
        const customerId = localStorage.getItem('userId');
        
        if (!token || !customerId) {
            alert('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng!');
            window.location.href = 'login.html';
            return;
        }

        const productDetailId = $(this).data('product-id');
        console.log('ProductDetailId:', productDetailId); // Log để debug

        // Kiểm tra sản phẩm đã có trong giỏ hàng chưa
        $.ajax({
            url: `https://localhost:7060/api/Cart/get-cart/${customerId}`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function(cartResponse) {
                const existingItem = cartResponse.items.find(item => 
                    item.productDetailId === productDetailId
                );

                if (existingItem) {
                    // Nếu sản phẩm đã tồn tại, cập nhật số lượng
                    const updateData = {
                        cartDetailId: existingItem.cartDetailId,
                        quantity: existingItem.quantity + 1
                    };

                    $.ajax({
                        url: 'https://localhost:7060/api/Cart/update-quantity',
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(updateData),
                        success: function(response) {
                            alert('Đã cập nhật số lượng trong giỏ hàng!');
                            updateCartCount();
                        },
                        error: function(xhr) {
                            console.error('Lỗi khi cập nhật số lượng:', xhr);
                            alert('Không thể cập nhật số lượng. Vui lòng thử lại sau.');
                        }
                    });
                } else {
                    // Nếu sản phẩm chưa có trong giỏ hàng, thêm mới
                    const cartData = {
                        productDetailId: parseInt(productDetailId), // Đảm bảo là số
                        quantity: 1,
                        customerId: parseInt(customerId)
                    };

                    console.log('Dữ liệu gửi đi:', cartData); // Log để debug

                    $.ajax({
                        url: 'https://localhost:7060/api/Cart/add-to-cart',
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(cartData),
                        success: function(response) {
                            alert('Thêm vào giỏ hàng thành công!');
                            updateCartCount();
                        },
                        error: function(xhr) {
                            console.error('Lỗi khi thêm vào giỏ hàng:', xhr);
                            let errorMessage = 'Không thể thêm vào giỏ hàng. ';
                            
                            if (xhr.responseText) {
                                try {
                                    const errorResponse = JSON.parse(xhr.responseText);
                                    errorMessage += errorResponse.message || 'Vui lòng thử lại sau.';
                                } catch (e) {
                                    errorMessage += 'Vui lòng thử lại sau.';
                                }
                            }
                            
                            alert(errorMessage);
                        }
                    });
                }
            },
            error: function(xhr) {
                console.error('Lỗi khi kiểm tra giỏ hàng:', xhr);
                if (xhr.status === 401) {
                    alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                    window.location.href = 'login.html';
                } else {
                    alert('Không thể kiểm tra giỏ hàng. Vui lòng thử lại sau.');
                }
            }
        });
        updateCartCount();
      });
    });
    </script>
    <script>
      $(document).ready(function () {
        // Show popup when clicking search icon
        $("#searchIcon").click(function(e) {
          e.preventDefault();
          $("#searchPopup").fadeIn(200);
          $("#searchInput").focus();
        });

        // Close popup when clicking outside
        $("#searchPopup").click(function(e) {
          if ($(e.target).is("#searchPopup")) {
            $(this).fadeOut(200);
          }
        });

        // Search functionality
        let searchTimeout; // Thêm biến để debounce
        
        $("#searchInput").on("input", function () {
          const query = $(this).val();
          const token = localStorage.getItem("token");

          // Clear previous timeout
          clearTimeout(searchTimeout);

          if (query.length > 0) {
            // Set new timeout
            searchTimeout = setTimeout(() => {
              $.ajax({
                url: `https://localhost:7060/api/ProductDetail/FindByName/${query}`,
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`
                },
                success: function(products) {
                  $("#searchResults").empty(); // Xóa kết quả cũ
                  
                  if (products && products.length > 0) {
                    const processedProducts = new Set(); // Theo dõi sản phẩm đã xử lý

                    products.forEach(product => {
                      // Kiểm tra nếu sản phẩm đã được xử lý
                      if (!processedProducts.has(product.id)) {
                        processedProducts.add(product.id); // Đánh dấu là đã xử lý

                        $.ajax({
                          url: `https://localhost:7060/api/ProductImage/productDetailId/${product.id}`,
                          method: 'GET',
                          headers: {
                            'Authorization': `Bearer ${token}`
                          },
                          success: function(images) {
                            const imageUrl = images && images.length > 0 
                              ? images[0].url 
                              : 'images/product_placeholder.jpg';
                            
                            const productHtml = `
                              <div class="search-item" data-id="${product.id}">
                                <div class="search-item-content">
                                  <img src="${imageUrl}" alt="${product.name}" class="search-item-image">
                                  <div class="search-item-details">
                                    <div class="search-item-name">${product.name}</div>
                                  </div>
                                </div>
                              </div>
                            `;
                            
                            $("#searchResults").append(productHtml);
                          },
                          error: function() {
                            // Nếu không lấy được ảnh, vẫn hiển thị sản phẩm với ảnh mặc định
                            const productHtml = `
                              <div class="search-item" data-id="${product.id}">
                                <div class="search-item-content">
                                  <img src="images/product_placeholder.jpg" alt="${product.name}" class="search-item-image">
                                  <div class="search-item-details">
                                    <div class="search-item-name">${product.name}</div>
                                  </div>
                                </div>
                              </div>
                            `;
                            
                            $("#searchResults").append(productHtml);
                          }
                        });
                      }
                    });
                    
                    $("#searchResults").show();
                  } else {
                    $("#searchResults").html('<div class="search-item">Không tìm thấy sản phẩm</div>');
                    $("#searchResults").show();
                  }
                },
                error: function(xhr) {
                  console.error("Lỗi khi tìm kiếm:", xhr);
                  $("#searchResults").html('<div class="search-item">Đã xảy ra lỗi khi tìm kiếm</div>');
                  $("#searchResults").show();
                }
              });
            }, 300); // Đợi 300ms sau khi người dùng ngừng gõ
          } else {
            $("#searchResults").hide();
          }
        });

        // Handle product click
        $(document).on("click", ".search-item", function () {
          const productId = $(this).data("id");
          window.location.href = `single.html?id=${productId}`;
        });

        // Clear search when popup closes
        $("#searchPopup").on("hidden", function() {
          $("#searchInput").val("");
          $("#searchResults").hide();
        });
      });
    </script>
  </body>
</html>
